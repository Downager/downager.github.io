<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Relk&#39;s 工作手札</title>
  
  <subtitle>在 Cloud-Native 汪洋中載浮載沉的 SRE - Service Restart Engineer</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.downager.com/"/>
  <updated>2020-12-13T04:49:21.010Z</updated>
  <id>https://blog.downager.com/</id>
  
  <author>
    <name>Relk Li</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>[除錯] Fluentd UDP Log 掉包問題分析</title>
    <link href="https://blog.downager.com/2020/07/19/%E9%99%A4%E9%8C%AF-Fluentd-UDP-Log-%E6%8E%89%E5%8C%85%E5%95%8F%E9%A1%8C%E5%88%86%E6%9E%90/"/>
    <id>https://blog.downager.com/2020/07/19/%E9%99%A4%E9%8C%AF-Fluentd-UDP-Log-%E6%8E%89%E5%8C%85%E5%95%8F%E9%A1%8C%E5%88%86%E6%9E%90/</id>
    <published>2020-07-19T14:46:45.000Z</published>
    <updated>2020-12-13T04:49:21.010Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前陣子與 Backend Team 最終討論出要使用 UDP 方式直接將 JSON format 的 log message 送到 fluentd，實際接上後觀察發現會掉 log，以下是除錯過程的紀錄。</p><h1 id="除錯紀錄"><a href="#除錯紀錄" class="headerlink" title="除錯紀錄"></a>除錯紀錄</h1><p>一開始不確定問題是 fluentd 丟棄太大的 UDP 封包還是 MTU 導致，於是建立了幾個特定大小的 JSON 檔案來測試：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la</span><br><span class="line">-rw-rw-r--  1 relk relk    1400 Jul 16 10:33 size-1400</span><br><span class="line">-rw-rw-r--  1 relk relk    1410 Jul 16 10:39 size-1410</span><br><span class="line">-rw-rw-r--  1 relk relk    1420 Jul 16 10:41 size-1420</span><br><span class="line">-rw-rw-r--  1 relk relk    1430 Jul 16 10:42 size-1430</span><br><span class="line">-rw-rw-r--  1 relk relk    1432 Jul 16 10:54 size-1432</span><br><span class="line">-rw-rw-r--  1 relk relk    1440 Jul 16 10:42 size-1440</span><br><span class="line">-rw-rw-r--  1 relk relk    2000 Jul 16 10:30 size-2000</span><br></pre></td></tr></table></figure><p>一開始先從 <code>2000 bytes</code> 的開始丟，檢查 fluentd log 沒發現有收到 <code>2000 bytes</code> 大小的 log，轉而測試 <code>1400 bytes</code> 到 <code>1440 bytes</code> 訊息後，發現超過 <code>1432 bytes</code> 的 log 像是被丟到黑洞一樣，不知去向</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat size-2000 &gt; &#x2F;dev&#x2F;udp&#x2F;192.168.100.200&#x2F;5160</span><br><span class="line">$ cat size-1400 &gt; &#x2F;dev&#x2F;udp&#x2F;192.168.100.200&#x2F;5160</span><br><span class="line">$ cat size-1432 &gt; &#x2F;dev&#x2F;udp&#x2F;192.168.100.200&#x2F;5160</span><br></pre></td></tr></table></figure><p>使用 <code>tcpdump</code> 來檢查 5160 port 的封包狀況，確認的確是封包過大會有 <code>UDP, bad length</code> 的錯誤訊息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i ens4 -nn -v &#39;port 5160&#39;</span><br><span class="line">08:15:07.295252 IP (tos 0x0, ttl 64, id 798, offset 0, flags [+], proto UDP (17), length 1460)</span><br><span class="line">    192.168.100.1.5160 &gt; 192.168.100.200.5160: UDP, bad length 2064 &gt; 1432</span><br></pre></td></tr></table></figure><a id="more"></a> <p>在 Google 上查了一下，看到有人<a href="https://iota.stackexchange.com/questions/756/possible-udp-mtu-problems-udp-bad-length-1650-1368-in-tcpdump" target="_blank" rel="noopener">提到</a> <code>udp-fragmentation-offload</code> 會導致這個問題，檢查了一下確實沒有開啟這功能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ethtool -k ens4 | grep udp-fragmentation-offload</span><br><span class="line">udp-fragmentation-offload: off</span><br></pre></td></tr></table></figure><p>針對這功能<a href="https://hustcat.github.io/udp-and-vxlan-fragment/" target="_blank" rel="noopener">研究</a>了下，<code>udp-fragmentation-offload (UFO)</code> 主要是網卡提供硬體 IP Fragmentation 的功能，使得上層 <code>Layer 3</code> 不需要透過軟體 Fragmentation，減少 CPU 資源消耗，因此我認為 UFO 的啟用與否不影響 UDP Packet 的發送。</p><p>根據這個思維，利用 <code>tcpdump</code> 來觀察所有發送到目標 fluentd 的封包：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$sudo tcpdump -i ens4 -nn -v -X &#39;dst host 192.168.100.200&#39;</span><br><span class="line"></span><br><span class="line">16:43:18.375508 IP (tos 0x0, ttl 64, id 30236, offset 0, flags [+], proto UDP (17), length 1460)</span><br><span class="line">    192.168.100.1.33543 &gt; 192.168.100.200.5160: UDP, bad length 1440 &gt; 1432</span><br><span class="line">0x0000:  4500 05b4 761c 2000 4011 c94c 0aa0 0002  E...v...@..L....</span><br><span class="line">0x0010:  0ac8 0067 8307 1428 05a8 090f 7b22 6c61  ...g...(....&#123;&quot;la</span><br><span class="line">0x0020:  6265 6c22 3a22 7265 6c6b 5f61 6363 6573  bel&quot;:&quot;relk_acces</span><br><span class="line">0x0030:  7322 2c22 6d65 7373 6167 6522 3a22 3634  s&quot;,&quot;message&quot;:&quot;64</span><br><span class="line">0x0040:  3634 3634 3634 3634 3634 3634 3634 3634  6464646464646464</span><br><span class="line">... 略</span><br><span class="line">0x0550:  3132 3232 3232 3232 3232 3233 3333 3333  1222222222233333</span><br><span class="line">0x0560:  3333 3333 3334 3434 3434 3434 3434 3422  333334444444444&quot;</span><br><span class="line">0x0570:  2c22 686f 7374 6e61 6d65 223a 2273 6973  ,&quot;hostname&quot;:&quot;my-</span><br><span class="line">0x0580:  7970 6875 7322 2c22 7069 6422 3a32 3233  host1&quot;,&quot;pid&quot;:123</span><br><span class="line">0x0590:  3336 2c22 7469 6d65 7374 616d 7022 3a22  45,&quot;timestamp&quot;:&quot;</span><br><span class="line">0x05a0:  3230 3230 2d30 372d 3136 5431 303a 3131  2020-07-16T10:11</span><br><span class="line">0x05b0:  3a32 392e                                :29.</span><br><span class="line">16:43:18.375526 IP (tos 0x0, ttl 64, id 30236, offset 1440, flags [none], proto UDP (17), length 28)</span><br><span class="line">    10.160.0.2 &gt; 192.168.100.200: ip-proto-17</span><br><span class="line">0x0000:  4500 001c 761c 00b4 4011 ee30 0aa0 0002  E...v...@..0....</span><br><span class="line">0x0010:  0ac8 0067 3238 3630 3022 7d0a            ...g28600&quot;&#125;.</span><br></pre></td></tr></table></figure><p>可以觀察到確實 IP Layer 會將大於 MTU 的封包做切割，而切割後會喪失 UDP Header，但接收端應該要能夠在 IP Layer 重組（IP Header 有 ID、offset），而我們目前測試的架構為 <code>VM</code> &gt; <code>GCP Internal Loadbalancer</code> &gt; <code>Kubernetes Worker Node</code>&gt; <code>Fluentd Pod (Kubernetes)</code>，為了定位問題點，我選擇先從 Kubernetes 內部測試被 IP 分片的 UDP Datagram 是否能組回且被 Fluentd 正確處理：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la</span><br><span class="line">-rw-r--r--    1 root     root          2312 Jul 19 12:37 size2300.txt</span><br><span class="line">$ cat size2300.txt | nc -u -w1 fluentd.monitoring 5160</span><br></pre></td></tr></table></figure><p>同時間在 Fluentd Pod 上進行 <code>tcpdump</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -v -A &#39;src host 10.203.0.20&#39;</span><br><span class="line"></span><br><span class="line">12:37:50.159977 IP (tos 0x0, ttl 62, id 42754, offset 0, flags [+], proto UDP (17), length 1460)</span><br><span class="line">    10.203.0.20.46424 &gt; 10.203.3.189.5160: UDP, bad length 2312 &gt; 1432</span><br><span class="line">E..... .&gt;...</span><br><span class="line">...</span><br><span class="line">....X.(..(</span><br><span class="line">&#123;&quot;label&quot;:&quot;relk_access&quot;,&quot;timestamp&quot;:&quot;2020-07-19T12:11:29.286Z&quot;,&quot;message&quot;:&quot;sEgYYUOdiyVk...略</span><br><span class="line"></span><br><span class="line">12:37:50.159993 IP (tos 0x0, ttl 62, id 42754, offset 1440, flags [none], proto UDP (17), length 900)</span><br><span class="line">    10.203.0.20 &gt; 10.203.3.189: ip-proto-17</span><br><span class="line">E.......&gt;..L</span><br><span class="line">...</span><br><span class="line">...VW0iQRjLz9QqVBzkfmNThUaOgC3HA4RkkhcoTYBJOS1rw8bwt9SD4xWMhLIa5X1uCrCdfgFnmp3A4I1NSeMYow2mbsa6...略&quot;&#125;</span><br></pre></td></tr></table></figure><p>可以看到接收端是有收到被分片過的 Packet，Fluentd 也有正確處理並送到 elasticsearch，因此可以確認說問題是出在 <code>GCP Internal Loadbalancer</code>，根據<a href="https://cloud.google.com/load-balancing/docs/network#load_balancing_and_fragmented_udp_packets" target="_blank" rel="noopener">文檔</a>指出：</p><blockquote><p>Google Cloud does not wait for all fragments; it forwards each fragment as soon as it arrives.</p><p>Because subsequent UDP fragments do not contain the destination port, problems can occur in these situations:</p><ul><li>If the target pools session affinity is set to NONE (5-tuple affinity), the subsequent fragments may be dropped because the load balancer cannot calculate the 5-tuple hash.</li><li>If there is more than one UDP forwarding rule for the same load-balanced IP address, subsequent fragments may arrive at the wrong forwarding rule.</li></ul></blockquote><p>可以看到根據 <code>session affinity</code> 的設定，可能會導致後續 <code>fragments</code> 被送到不正確的目的地或是被丟棄，基本上可以確定這次掉 Log 是 Loadbalancer 導致，查了一下沒有找到能夠調整 <code>session affinity</code> 的 Kubernetes service annotations，暫時擱置著先，再想想要怎麼解決這問題…</p><p><strong>2020/07/31 Update:</strong><br>後續測試時發現部份 log message 會超過 UDP datagram 大小限制 <code>65,535 bytes</code>，只好轉回用 TCP 做為連線協定，回去面對 Long-Lived TCP 連線的負載平衡問題，以及 TCP 連線開銷等等性能挑戰。<br>可以參考 <a href="https://docs.fluentd.org/installation/before-install" target="_blank" rel="noopener">Before Installation - Fluentd</a>，有提到關於 File Descriptors 及 Network Kernel Parameters 等等的調整</p><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://iota.stackexchange.com/questions/756/possible-udp-mtu-problems-udp-bad-length-1650-1368-in-tcpdump" target="_blank" rel="noopener">Possible UDP MTU problems (UDP, bad length 1650 &gt; 1368 in tcpdump)</a></li><li><a href="https://www.zhihu.com/question/68641339" target="_blank" rel="noopener">UDP分片的问题？ - 知乎</a></li><li><a href="https://hustcat.github.io/udp-and-vxlan-fragment/" target="_blank" rel="noopener">Packet fragmentation and segmentation offload in UDP and VXLAN</a></li><li><a href="http://blog.nsfocus.net/network-packets-analysis-nic-offload/" target="_blank" rel="noopener">网络数据包分析 网卡OFFLOAD</a></li><li><a href="https://cloud.google.com/load-balancing/docs/network#load_balancing_and_fragmented_udp_packets" target="_blank" rel="noopener">#Load balancing and fragmented UDP packets</a></li><li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/internal-load-balancing#restrictions_for_internal_udp_load_balancers" target="_blank" rel="noopener">#Restrictions for internal UDP load balancers</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;前陣子與 Backend Team 最終討論出要使用 UDP 方式直接將 JSON format 的 log message 送到 fluentd，實際接上後觀察發現會掉 log，以下是除錯過程的紀錄。&lt;/p&gt;
&lt;h1 id=&quot;除錯紀錄&quot;&gt;&lt;a href=&quot;#除錯紀錄&quot; class=&quot;headerlink&quot; title=&quot;除錯紀錄&quot;&gt;&lt;/a&gt;除錯紀錄&lt;/h1&gt;&lt;p&gt;一開始不確定問題是 fluentd 丟棄太大的 UDP 封包還是 MTU 導致，於是建立了幾個特定大小的 JSON 檔案來測試：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ ls -la&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-rw-rw-r--  1 relk relk    1400 Jul 16 10:33 size-1400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-rw-rw-r--  1 relk relk    1410 Jul 16 10:39 size-1410&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-rw-rw-r--  1 relk relk    1420 Jul 16 10:41 size-1420&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-rw-rw-r--  1 relk relk    1430 Jul 16 10:42 size-1430&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-rw-rw-r--  1 relk relk    1432 Jul 16 10:54 size-1432&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-rw-rw-r--  1 relk relk    1440 Jul 16 10:42 size-1440&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-rw-rw-r--  1 relk relk    2000 Jul 16 10:30 size-2000&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;一開始先從 &lt;code&gt;2000 bytes&lt;/code&gt; 的開始丟，檢查 fluentd log 沒發現有收到 &lt;code&gt;2000 bytes&lt;/code&gt; 大小的 log，轉而測試 &lt;code&gt;1400 bytes&lt;/code&gt; 到 &lt;code&gt;1440 bytes&lt;/code&gt; 訊息後，發現超過 &lt;code&gt;1432 bytes&lt;/code&gt; 的 log 像是被丟到黑洞一樣，不知去向&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat size-2000 &amp;gt; &amp;#x2F;dev&amp;#x2F;udp&amp;#x2F;192.168.100.200&amp;#x2F;5160&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat size-1400 &amp;gt; &amp;#x2F;dev&amp;#x2F;udp&amp;#x2F;192.168.100.200&amp;#x2F;5160&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat size-1432 &amp;gt; &amp;#x2F;dev&amp;#x2F;udp&amp;#x2F;192.168.100.200&amp;#x2F;5160&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用 &lt;code&gt;tcpdump&lt;/code&gt; 來檢查 5160 port 的封包狀況，確認的確是封包過大會有 &lt;code&gt;UDP, bad length&lt;/code&gt; 的錯誤訊息：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sudo tcpdump -i ens4 -nn -v &amp;#39;port 5160&amp;#39;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;08:15:07.295252 IP (tos 0x0, ttl 64, id 798, offset 0, flags [+], proto UDP (17), length 1460)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    192.168.100.1.5160 &amp;gt; 192.168.100.200.5160: UDP, bad length 2064 &amp;gt; 1432&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Cloud-Native" scheme="https://blog.downager.com/categories/Cloud-Native/"/>
    
    
      <category term="kubernetes" scheme="https://blog.downager.com/tags/kubernetes/"/>
    
      <category term="fluentd" scheme="https://blog.downager.com/tags/fluentd/"/>
    
      <category term="除錯" scheme="https://blog.downager.com/tags/%E9%99%A4%E9%8C%AF/"/>
    
      <category term="udp" scheme="https://blog.downager.com/tags/udp/"/>
    
  </entry>
  
  <entry>
    <title>[Elastic] 利用 Filebeat 來收集與解析 Kubernetes nginx ingress logs</title>
    <link href="https://blog.downager.com/2020/06/14/Elastic-%E5%88%A9%E7%94%A8-Filebeat-%E4%BE%86%E6%94%B6%E9%9B%86%E8%88%87%E8%A7%A3%E6%9E%90-Kubernetes-nginx-ingress-logs/"/>
    <id>https://blog.downager.com/2020/06/14/Elastic-%E5%88%A9%E7%94%A8-Filebeat-%E4%BE%86%E6%94%B6%E9%9B%86%E8%88%87%E8%A7%A3%E6%9E%90-Kubernetes-nginx-ingress-logs/</id>
    <published>2020-06-14T04:56:16.000Z</published>
    <updated>2020-11-19T05:50:50.479Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在配置 Filebeat 在 Kubernetes 上解析 nginx-ingress logs 時遇到了一些困難，主要是 <code>autodiscover</code> 與 <code>hints</code> 部份在新舊版本上有些差異，這邊將我最後測試成功的配置給記錄下來</p><h1 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h1><ul><li><code>GKE Container-Optimized OS</code></li><li><code>Filebeat: 7.7.1</code></li><li><code>ElasticSearch: 7.7.1</code></li><li><code>Kubernetes/ingress-nginx: 0.32.0</code></li></ul><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h4 id="helm-chart-elastic-filebeat"><a href="#helm-chart-elastic-filebeat" class="headerlink" title="helm chart: elastic/filebeat"></a>helm chart: <code>elastic/filebeat</code></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeatConfig:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">filebeat.autodiscover:</span></span><br><span class="line">      <span class="attr">providers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">kubernetes</span></span><br><span class="line">          <span class="attr">hints.enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">hints.default_config.enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">output.elasticsearch:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">'$&#123;NODE_NAME&#125;'</span></span><br><span class="line">      <span class="attr">hosts:</span> <span class="string">'$&#123;ELASTICSEARCH_HOSTS:elasticsearch-master:9200&#125;'</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">'$&#123;ELASTICSEARCH_USERNAME&#125;'</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">'$&#123;ELASTICSEARCH_PASSWORD&#125;'</span></span><br></pre></td></tr></table></figure><a id="more"></a> <h4 id="helm-chart-ingress-nginx-ingress-nginx"><a href="#helm-chart-ingress-nginx-ingress-nginx" class="headerlink" title="helm chart: ingress-nginx/ingress-nginx"></a>helm chart: <code>ingress-nginx/ingress-nginx</code></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Annotations to be added to controller pods</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="attr">podAnnotations:</span> </span><br><span class="line">  <span class="attr">co.elastic.logs/enabled:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="attr">co.elastic.logs/module:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="attr">co.elastic.logs/fileset.stdout:</span> <span class="string">"ingress_controller"</span></span><br><span class="line">  <span class="attr">co.elastic.logs/fileset.stderr:</span> <span class="string">"error"</span></span><br></pre></td></tr></table></figure><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://stackoverflow.com/questions/62302527/error-extracting-container-id-source-value-does-not-contain-matchers-logs-pat" target="_blank" rel="noopener">Error extracting container id - source value does not contain matcher’s logs_path ‘/var/lib/docker/containers/‘</a></li><li><a href="https://discuss.elastic.co/t/problem-to-update-to-filebeat-7-7-0-and-parser-nginx-ingress-controller-on-kubernetes/232461/2" target="_blank" rel="noopener">Problem to update to filebeat 7.7.0 and parser nginx-ingress-controller on Kubernetes</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;最近在配置 Filebeat 在 Kubernetes 上解析 nginx-ingress logs 時遇到了一些困難，主要是 &lt;code&gt;autodiscover&lt;/code&gt; 與 &lt;code&gt;hints&lt;/code&gt; 部份在新舊版本上有些差異，這邊將我最後測試成功的配置給記錄下來&lt;/p&gt;
&lt;h1 id=&quot;環境&quot;&gt;&lt;a href=&quot;#環境&quot; class=&quot;headerlink&quot; title=&quot;環境&quot;&gt;&lt;/a&gt;環境&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;GKE Container-Optimized OS&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Filebeat: 7.7.1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ElasticSearch: 7.7.1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Kubernetes/ingress-nginx: 0.32.0&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;配置&quot;&gt;&lt;a href=&quot;#配置&quot; class=&quot;headerlink&quot; title=&quot;配置&quot;&gt;&lt;/a&gt;配置&lt;/h1&gt;&lt;h4 id=&quot;helm-chart-elastic-filebeat&quot;&gt;&lt;a href=&quot;#helm-chart-elastic-filebeat&quot; class=&quot;headerlink&quot; title=&quot;helm chart: elastic/filebeat&quot;&gt;&lt;/a&gt;helm chart: &lt;code&gt;elastic/filebeat&lt;/code&gt;&lt;/h4&gt;&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;filebeatConfig:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;filebeat.yml:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;filebeat.autodiscover:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;providers:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;bullet&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;type:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;kubernetes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attr&quot;&gt;hints.enabled:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;attr&quot;&gt;hints.default_config.enabled:&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;attr&quot;&gt;output.elasticsearch:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;host:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;$&amp;#123;NODE_NAME&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;hosts:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;$&amp;#123;ELASTICSEARCH_HOSTS:elasticsearch-master:9200&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;protocol:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;http&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;username:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;$&amp;#123;ELASTICSEARCH_USERNAME&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;attr&quot;&gt;password:&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;$&amp;#123;ELASTICSEARCH_PASSWORD&amp;#125;&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Elastic" scheme="https://blog.downager.com/categories/Elastic/"/>
    
    
      <category term="kubernetes" scheme="https://blog.downager.com/tags/kubernetes/"/>
    
      <category term="elasticsearch" scheme="https://blog.downager.com/tags/elasticsearch/"/>
    
      <category term="ingress" scheme="https://blog.downager.com/tags/ingress/"/>
    
      <category term="nginx" scheme="https://blog.downager.com/tags/nginx/"/>
    
      <category term="filebeat" scheme="https://blog.downager.com/tags/filebeat/"/>
    
  </entry>
  
  <entry>
    <title>[Raspberry Pi] 設定開機自動掛載 exFAT 格式行動硬碟</title>
    <link href="https://blog.downager.com/2020/05/30/Raspberry-Pi-%E8%A8%AD%E5%AE%9A%E9%96%8B%E6%A9%9F%E8%87%AA%E5%8B%95%E6%8E%9B%E8%BC%89-exFAT-%E6%A0%BC%E5%BC%8F%E8%A1%8C%E5%8B%95%E7%A1%AC%E7%A2%9F/"/>
    <id>https://blog.downager.com/2020/05/30/Raspberry-Pi-%E8%A8%AD%E5%AE%9A%E9%96%8B%E6%A9%9F%E8%87%AA%E5%8B%95%E6%8E%9B%E8%BC%89-exFAT-%E6%A0%BC%E5%BC%8F%E8%A1%8C%E5%8B%95%E7%A1%AC%E7%A2%9F/</id>
    <published>2020-05-30T08:46:47.000Z</published>
    <updated>2020-11-19T05:50:50.479Z</updated>
    
    <content type="html"><![CDATA[<h4 id="1-接上行動硬碟，檢查一下被分配到哪個裝置代號"><a href="#1-接上行動硬碟，檢查一下被分配到哪個裝置代號" class="headerlink" title="1. 接上行動硬碟，檢查一下被分配到哪個裝置代號"></a>1. 接上行動硬碟，檢查一下被分配到哪個裝置代號</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看分割表狀態</span><br><span class="line">sudo fdisk -l</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Disk &#x2F;dev&#x2F;mmcblk0: 29.7 GiB, 31914983424 bytes, 62333952 sectors</span><br><span class="line">Units: sectors of 1 * 512 &#x3D; 512 bytes</span><br><span class="line">Sector size (logical&#x2F;physical): 512 bytes &#x2F; 512 bytes</span><br><span class="line">I&#x2F;O size (minimum&#x2F;optimal): 512 bytes &#x2F; 512 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0xda84cd12</span><br><span class="line"></span><br><span class="line">Device         Boot  Start      End  Sectors  Size Id Type</span><br><span class="line">&#x2F;dev&#x2F;mmcblk0p1 *      2048   526335   524288  256M  c W95 FAT32 (LBA)</span><br><span class="line">&#x2F;dev&#x2F;mmcblk0p2      526336 62333918 61807583 29.5G 83 Linux</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disk &#x2F;dev&#x2F;sda: 1.8 TiB, 2000398934016 bytes, 3907029168 sectors</span><br><span class="line">Units: sectors of 1 * 512 &#x3D; 512 bytes</span><br><span class="line">Sector size (logical&#x2F;physical): 512 bytes &#x2F; 4096 bytes</span><br><span class="line">I&#x2F;O size (minimum&#x2F;optimal): 4096 bytes &#x2F; 4096 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0x2ac1c561</span><br><span class="line"></span><br><span class="line">Device     Boot Start        End    Sectors  Size Id Type</span><br><span class="line">&#x2F;dev&#x2F;sda1  *     2048 3907026943 3907024896  1.8T  c W95 FAT32 (LBA)</span><br></pre></td></tr></table></figure><a id="more"></a> <h4 id="2-將硬碟分割表設定成-GPT，並建立一個完整的磁碟分割"><a href="#2-將硬碟分割表設定成-GPT，並建立一個完整的磁碟分割" class="headerlink" title="2. 將硬碟分割表設定成 GPT，並建立一個完整的磁碟分割"></a>2. 將硬碟分割表設定成 <code>GPT</code>，並建立一個完整的磁碟分割</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 設定分割表</span><br><span class="line">sudo fdisk &#x2F;dev&#x2F;sda</span><br></pre></td></tr></table></figure><ol><li>輸入 <code>g</code> 設定成 <code>GPT</code> 分割表 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Command (m for help): g</span><br><span class="line">Created a new GPT disklabel (GUID: 2BD8CEBF-23A4-4C49-B0E5-3D8A45B6E883).</span><br></pre></td></tr></table></figure></li><li>輸入 <code>n</code> 建立新磁碟分區 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Command (m for help): n</span><br><span class="line">Partition number (1-128, default 1): 1</span><br><span class="line">First sector (2048-3907029134, default 2048): 2048</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G,T,P&#125; (2048-3907029134, default 3907029134): 3907029134</span><br><span class="line"></span><br><span class="line">Created a new partition 1 of type &#39;Linux filesystem&#39; and of size 1.8 TiB.</span><br><span class="line">Partition #1 contains a exfat signature.</span><br><span class="line"></span><br><span class="line">Do you want to remove the signature? [Y]es&#x2F;[N]o: Y</span><br><span class="line"></span><br><span class="line">The signature will be removed by a write command.</span><br></pre></td></tr></table></figure></li><li>輸入 <code>p</code> 檢查分區狀況，沒問題後輸入 <code>w</code> 寫入 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Command (m for help): p</span><br><span class="line">Disk &#x2F;dev&#x2F;sda: 1.8 TiB, 2000398934016 bytes, 3907029168 sectors</span><br><span class="line">Units: sectors of 1 * 512 &#x3D; 512 bytes</span><br><span class="line">Sector size (logical&#x2F;physical): 512 bytes &#x2F; 4096 bytes</span><br><span class="line">I&#x2F;O size (minimum&#x2F;optimal): 4096 bytes &#x2F; 4096 bytes</span><br><span class="line">Disklabel type: gpt</span><br><span class="line">Disk identifier: 2BD8CEBF-23A4-4C49-B0E5-3D8A45B6E883</span><br><span class="line"></span><br><span class="line">Device     Start        End    Sectors  Size Type</span><br><span class="line">&#x2F;dev&#x2F;sda1   2048 3907029134 3907027087  1.8T Linux filesystem</span><br><span class="line"></span><br><span class="line">Filesystem&#x2F;RAID signature on partition 1 will be wiped.</span><br><span class="line"></span><br><span class="line">Command (m for help): w</span><br><span class="line">The partition table has been altered.</span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure></li></ol><h4 id="3-將硬碟掛載到-media-external-hd-下，並設定開機自動掛載"><a href="#3-將硬碟掛載到-media-external-hd-下，並設定開機自動掛載" class="headerlink" title="3. 將硬碟掛載到 /media/external-hd 下，並設定開機自動掛載"></a>3. 將硬碟掛載到 <code>/media/external-hd</code> 下，並設定開機自動掛載</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 安裝 exFAT 相關套件</span><br><span class="line">sudo apt install exfat-fuse exfat-utils</span><br><span class="line"></span><br><span class="line"># 將硬碟格式化成 exFAT 格式</span><br><span class="line">sudo mkfs.exfat &#x2F;dev&#x2F;sda1</span><br><span class="line"></span><br><span class="line"># 建立掛載資料夾</span><br><span class="line">mkdir &#x2F;media&#x2F;external-hd&#x2F;</span><br><span class="line"></span><br><span class="line"># 編輯 fstab 設定開機自動掛載</span><br><span class="line">sudo vim &#x2F;etc&#x2F;fstab</span><br><span class="line"></span><br><span class="line"># 將以下內容增加到 &#x2F;etc&#x2F;fstab 最尾行</span><br><span class="line">&#x2F;dev&#x2F;sda1    &#x2F;media&#x2F;external-hd&#x2F;    exfat    defaults    0 0</span><br><span class="line"></span><br><span class="line"># 將硬碟掛載上去</span><br><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure><h4 id="4-檢查掛載狀況"><a href="#4-檢查掛載狀況" class="headerlink" title="4. 檢查掛載狀況"></a>4. 檢查掛載狀況</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@raspberry-pi:~$ lsblk</span><br><span class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda           8:0    0  1.8T  0 disk </span><br><span class="line">└─sda1        8:1    0  1.8T  0 part &#x2F;media&#x2F;external-hd</span><br><span class="line">mmcblk0     179:0    0 29.7G  0 disk </span><br><span class="line">├─mmcblk0p1 179:1    0  256M  0 part &#x2F;boot&#x2F;firmware</span><br><span class="line">└─mmcblk0p2 179:2    0 29.5G  0 part &#x2F;</span><br><span class="line"></span><br><span class="line">ubuntu@raspberry-pi:~$ df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev            1.9G     0  1.9G   0% &#x2F;dev</span><br><span class="line">tmpfs           380M  7.0M  373M   2% &#x2F;run</span><br><span class="line">&#x2F;dev&#x2F;mmcblk0p2   29G  3.1G   25G  12% &#x2F;</span><br><span class="line">tmpfs           1.9G     0  1.9G   0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs           5.0M     0  5.0M   0% &#x2F;run&#x2F;lock</span><br><span class="line">tmpfs           1.9G     0  1.9G   0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;mmcblk0p1  253M  116M  137M  46% &#x2F;boot&#x2F;firmware</span><br><span class="line">&#x2F;dev&#x2F;sda1       1.9T   61M  1.9T   1% &#x2F;media&#x2F;external-hd</span><br><span class="line">tmpfs           380M     0  380M   0% &#x2F;run&#x2F;user&#x2F;1000</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;1-接上行動硬碟，檢查一下被分配到哪個裝置代號&quot;&gt;&lt;a href=&quot;#1-接上行動硬碟，檢查一下被分配到哪個裝置代號&quot; class=&quot;headerlink&quot; title=&quot;1. 接上行動硬碟，檢查一下被分配到哪個裝置代號&quot;&gt;&lt;/a&gt;1. 接上行動硬碟，檢查一下被分配到哪個裝置代號&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# 查看分割表狀態&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo fdisk -l&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Disk &amp;#x2F;dev&amp;#x2F;mmcblk0: 29.7 GiB, 31914983424 bytes, 62333952 sectors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Units: sectors of 1 * 512 &amp;#x3D; 512 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Sector size (logical&amp;#x2F;physical): 512 bytes &amp;#x2F; 512 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I&amp;#x2F;O size (minimum&amp;#x2F;optimal): 512 bytes &amp;#x2F; 512 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Disklabel type: dos&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Disk identifier: 0xda84cd12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Device         Boot  Start      End  Sectors  Size Id Type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#x2F;dev&amp;#x2F;mmcblk0p1 *      2048   526335   524288  256M  c W95 FAT32 (LBA)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#x2F;dev&amp;#x2F;mmcblk0p2      526336 62333918 61807583 29.5G 83 Linux&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Disk &amp;#x2F;dev&amp;#x2F;sda: 1.8 TiB, 2000398934016 bytes, 3907029168 sectors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Units: sectors of 1 * 512 &amp;#x3D; 512 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Sector size (logical&amp;#x2F;physical): 512 bytes &amp;#x2F; 4096 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;I&amp;#x2F;O size (minimum&amp;#x2F;optimal): 4096 bytes &amp;#x2F; 4096 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Disklabel type: dos&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Disk identifier: 0x2ac1c561&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Device     Boot Start        End    Sectors  Size Id Type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#x2F;dev&amp;#x2F;sda1  *     2048 3907026943 3907024896  1.8T  c W95 FAT32 (LBA)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.downager.com/categories/Linux/"/>
    
    
      <category term="Raspberry-Pi" scheme="https://blog.downager.com/tags/Raspberry-Pi/"/>
    
      <category term="Linux" scheme="https://blog.downager.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>[Kubernetes] 在 GKE 上同時啟用 internal 與 external 兩種 nginx ingress controller</title>
    <link href="https://blog.downager.com/2020/05/17/Kubernetes-%E5%9C%A8-GKE-%E4%B8%8A%E5%90%8C%E6%99%82%E5%95%9F%E7%94%A8-internal-%E8%88%87-external-%E5%85%A9%E7%A8%AE-nginx-ingress-controller/"/>
    <id>https://blog.downager.com/2020/05/17/Kubernetes-%E5%9C%A8-GKE-%E4%B8%8A%E5%90%8C%E6%99%82%E5%95%9F%E7%94%A8-internal-%E8%88%87-external-%E5%85%A9%E7%A8%AE-nginx-ingress-controller/</id>
    <published>2020-05-16T16:46:20.000Z</published>
    <updated>2020-11-19T05:50:50.479Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>GKE 上原生的 Ingress Controller 限制非常多，需要設定 <code>ServiceType=NodePort</code> 才能使用，<br>於是我選擇 <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">kubernetes/ingress-nginx</a> 來作為 ingress 使用，不要和我一樣一開始裝成 <a href="https://github.com/nginxinc/kubernetes-ingress" target="_blank" rel="noopener">nginxinc/kubernetes-ingress</a> 的 Ingress Controller XD</p><p>這張圖是 Kube Ingress Controller 在 GKE 上的架構，除了 external 以外我還需要 internal 的 ingress</p><img src="/2020/05/17/Kubernetes-%E5%9C%A8-GKE-%E4%B8%8A%E5%90%8C%E6%99%82%E5%95%9F%E7%94%A8-internal-%E8%88%87-external-%E5%85%A9%E7%A8%AE-nginx-ingress-controller/gke-ingress.png" class="" title="gke-ingress"><a id="more"></a> <p>所以我總共會起兩個 Ingress Controller，Ingress Class 分別是 <code>nginx</code> 與 <code>nginx-internal</code>，<br>只要在 Ingress Controller 的 Service annotations 加上 <code>cloud.google.com/load-balancer-type: &quot;Internal&quot;</code>，<br>GKE 就會起 Internal Loadbalancer 給你的 ingress controller，詳細可以參考以下步驟來安裝</p><h1 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h1><ol><li>下載 kube-ingress 的 helm chart <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm repo add ingress-nginx https:&#x2F;&#x2F;kubernetes.github.io&#x2F;ingress-nginx</span><br><span class="line">helm repo update</span><br><span class="line">helm fetch ingress-nginx&#x2F;ingress-nginx</span><br><span class="line">tar zxvf ingress-nginx-2.1.0.tgz</span><br></pre></td></tr></table></figure></li><li>安裝 external kube-ingress，根據自己需求修改 default value <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install ingress-nginx --namespace default ingress-nginx&#x2F;</span><br></pre></td></tr></table></figure></li><li>新建一個叫 <code>internal-values.yml</code> 的文件，放到 <code>ingress-nginx/</code> 底下 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">controller:</span></span><br><span class="line">  <span class="attr">ingressClass:</span> <span class="string">nginx-internal</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cloud.google.com/load-balancer-type:</span> <span class="string">"Internal"</span></span><br></pre></td></tr></table></figure></li><li>安裝 internal kube-ingress <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install ingress-nginx-internal --namespace default ingress-nginx&#x2F; -f internal-values.yml</span><br></pre></td></tr></table></figure></li><li>檢查 ingress controller 的 LoadBalancer 是否如預期配到需要的 IP <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># relk @ relk-Inspiron-7375 in ~ [0:35:09] </span><br><span class="line">$ k get service</span><br><span class="line">NAME                                          TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                      AGE</span><br><span class="line">ingress-nginx-controller                      LoadBalancer   10.202.0.24     35.***.***.164   80:30499&#x2F;TCP,443:31137&#x2F;TCP   32h</span><br><span class="line">ingress-nginx-internal-controller             LoadBalancer   10.202.15.138   10.200.***.***   80:32401&#x2F;TCP,443:32427&#x2F;TCP   32h</span><br></pre></td></tr></table></figure></li></ol><h1 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h1><ol><li>宣告新的 ingress，在 annotations 下指定你要哪種 ingress class (Repo: <a href="https://github.com/Downager/gke-kube-ingress-demo" target="_blank" rel="noopener">gke-kube-ingress-demo</a>) <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># External Ingress</span></span><br><span class="line"><span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line"><span class="comment"># Internal Ingress</span></span><br><span class="line"><span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx-internal</span></span><br></pre></td></tr></table></figure></li><li>檢查結果 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># relk @ relk-Inspiron-7375 in ~ [0:59:35] </span><br><span class="line">$ kgi</span><br><span class="line">NAME                HOSTS                           ADDRESS          PORTS     AGE</span><br><span class="line">demo-app            demo-app.example.com            35.***.***.164   80        35s</span><br><span class="line">demo-app-internal   demo-app-internal.example.com   10.200.***.***   80        29s</span><br></pre></td></tr></table></figure></li></ol><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://www.infoq.cn/article/FwOkvi6zuxDSsiALsaHz" target="_blank" rel="noopener">GKE 多种 Ingress 的实现</a></li><li><a href="https://cloud.google.com/community/tutorials/nginx-ingress-gke" target="_blank" rel="noopener">Ingress with NGINX controller on Google Kubernetes Engine</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;GKE 上原生的 Ingress Controller 限制非常多，需要設定 &lt;code&gt;ServiceType=NodePort&lt;/code&gt; 才能使用，&lt;br&gt;於是我選擇 &lt;a href=&quot;https://github.com/kubernetes/ingress-nginx&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;kubernetes/ingress-nginx&lt;/a&gt; 來作為 ingress 使用，不要和我一樣一開始裝成 &lt;a href=&quot;https://github.com/nginxinc/kubernetes-ingress&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;nginxinc/kubernetes-ingress&lt;/a&gt; 的 Ingress Controller XD&lt;/p&gt;
&lt;p&gt;這張圖是 Kube Ingress Controller 在 GKE 上的架構，除了 external 以外我還需要 internal 的 ingress&lt;/p&gt;
&lt;img src=&quot;/2020/05/17/Kubernetes-%E5%9C%A8-GKE-%E4%B8%8A%E5%90%8C%E6%99%82%E5%95%9F%E7%94%A8-internal-%E8%88%87-external-%E5%85%A9%E7%A8%AE-nginx-ingress-controller/gke-ingress.png&quot; class=&quot;&quot; title=&quot;gke-ingress&quot;&gt;
    
    </summary>
    
    
      <category term="Cloud-Native" scheme="https://blog.downager.com/categories/Cloud-Native/"/>
    
    
      <category term="kubernetes" scheme="https://blog.downager.com/tags/kubernetes/"/>
    
      <category term="ingress" scheme="https://blog.downager.com/tags/ingress/"/>
    
      <category term="nginx" scheme="https://blog.downager.com/tags/nginx/"/>
    
      <category term="GKE" scheme="https://blog.downager.com/tags/GKE/"/>
    
  </entry>
  
  <entry>
    <title>[除錯] G-Suite 被擋信問題排除</title>
    <link href="https://blog.downager.com/2020/05/13/%E9%99%A4%E9%8C%AF-G-Suite-%E8%A2%AB%E6%93%8B%E4%BF%A1%E5%95%8F%E9%A1%8C%E6%8E%92%E9%99%A4/"/>
    <id>https://blog.downager.com/2020/05/13/%E9%99%A4%E9%8C%AF-G-Suite-%E8%A2%AB%E6%93%8B%E4%BF%A1%E5%95%8F%E9%A1%8C%E6%8E%92%E9%99%A4/</id>
    <published>2020-05-13T10:16:48.000Z</published>
    <updated>2020-11-19T05:50:50.475Z</updated>
    
    <content type="html"><![CDATA[<h1 id="除錯紀錄"><a href="#除錯紀錄" class="headerlink" title="除錯紀錄"></a>除錯紀錄</h1><p>最近公司同仁有在抱怨常常寄信到特定單位會寄丟，利用 <a href="https://toolbox.googleapps.com/apps/checkmx/" target="_blank" rel="noopener">Google CheckMX</a> 檢查發現</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SPF must allow Google servers to send mail on behalf of your domain.</span><br></pre></td></tr></table></figure><img src="/2020/05/13/%E9%99%A4%E9%8C%AF-G-Suite-%E8%A2%AB%E6%93%8B%E4%BF%A1%E5%95%8F%E9%A1%8C%E6%8E%92%E9%99%A4/spf-must-allow-google.png" class="" title="spf-must-allow-google"><p>根據<a href="https://support.google.com/a/answer/33786?hl=zh-Hant" target="_blank" rel="noopener">說明文件</a>表示，需要新增一筆 <code>SPF TXT Record</code> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v&#x3D;spf1 include:_spf.google.com ~all</span><br></pre></td></tr></table></figure><a id="more"></a> <p>由於我們有利用第三方 Mail Service 來寄信，可以使用 <a href="https://www.spfwizard.net/" target="_blank" rel="noopener">SPF Wizard</a> 來幫助產出正確的 <code>SPF TXT Record</code><br>在 <code>Any domains that may deliver or relay mail for this domain</code> 新增所有 Mail Service 的 Domain</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_spf.google.com mailgun.org</span><br></pre></td></tr></table></figure><img src="/2020/05/13/%E9%99%A4%E9%8C%AF-G-Suite-%E8%A2%AB%E6%93%8B%E4%BF%A1%E5%95%8F%E9%A1%8C%E6%8E%92%E9%99%A4/spf-wizard.png" class="" title="spf-wizard"><p>到 DNS Server 更新 <code>SPF TXT Record</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v&#x3D;spf1 include:_spf.google.com include:mailgun.org ~all</span><br></pre></td></tr></table></figure><p>回到 <a href="https://toolbox.googleapps.com/apps/checkmx/" target="_blank" rel="noopener">Google CheckMX</a> 檢查，通過測試～～</p><img src="/2020/05/13/%E9%99%A4%E9%8C%AF-G-Suite-%E8%A2%AB%E6%93%8B%E4%BF%A1%E5%95%8F%E9%A1%8C%E6%8E%92%E9%99%A4/checkmx-successes.png" class="" title="checkmx-successes">]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;除錯紀錄&quot;&gt;&lt;a href=&quot;#除錯紀錄&quot; class=&quot;headerlink&quot; title=&quot;除錯紀錄&quot;&gt;&lt;/a&gt;除錯紀錄&lt;/h1&gt;&lt;p&gt;最近公司同仁有在抱怨常常寄信到特定單位會寄丟，利用 &lt;a href=&quot;https://toolbox.googleapps.com/apps/checkmx/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Google CheckMX&lt;/a&gt; 檢查發現&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;SPF must allow Google servers to send mail on behalf of your domain.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;img src=&quot;/2020/05/13/%E9%99%A4%E9%8C%AF-G-Suite-%E8%A2%AB%E6%93%8B%E4%BF%A1%E5%95%8F%E9%A1%8C%E6%8E%92%E9%99%A4/spf-must-allow-google.png&quot; class=&quot;&quot; title=&quot;spf-must-allow-google&quot;&gt;


&lt;p&gt;根據&lt;a href=&quot;https://support.google.com/a/answer/33786?hl=zh-Hant&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;說明文件&lt;/a&gt;表示，需要新增一筆 &lt;code&gt;SPF TXT Record&lt;/code&gt; &lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;v&amp;#x3D;spf1 include:_spf.google.com ~all&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="MIS" scheme="https://blog.downager.com/categories/MIS/"/>
    
    
      <category term="除錯" scheme="https://blog.downager.com/tags/%E9%99%A4%E9%8C%AF/"/>
    
      <category term="G-Suite" scheme="https://blog.downager.com/tags/G-Suite/"/>
    
  </entry>
  
  <entry>
    <title>[除錯] SSL Certificate Troubleshooting 記錄</title>
    <link href="https://blog.downager.com/2020/05/13/%E9%99%A4%E9%8C%AF-SSL-Certificate-Troubleshooting-%E8%A8%98%E9%8C%84/"/>
    <id>https://blog.downager.com/2020/05/13/%E9%99%A4%E9%8C%AF-SSL-Certificate-Troubleshooting-%E8%A8%98%E9%8C%84/</id>
    <published>2020-05-13T09:35:32.000Z</published>
    <updated>2020-11-19T05:50:50.479Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p>利用 openssl-cli 來測試目標 domain</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect example.com:443</span><br></pre></td></tr></table></figure></li><li><p>檢視輸出訊息，會顯示 <code>Certificate chain</code>、<code>Server certificate</code>、<code>Verification</code>、<code>SSL handshake</code> 等資訊</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">Certificate chain</span><br><span class="line"> 0 s:OU &#x3D; Domain Control Validated, CN &#x3D; *.example.com</span><br><span class="line">   i:C &#x3D; US, ST &#x3D; Arizona, L &#x3D; Scottsdale, O &#x3D; &quot;GoDaddy.com, Inc.&quot;, OU &#x3D; http:&#x2F;&#x2F;certs.godaddy.com&#x2F;repository&#x2F;, CN &#x3D; Go Daddy Secure Certificate Authority - G2</span><br><span class="line">---</span><br><span class="line">SSL handshake has read 2283 bytes and written 420 bytes</span><br><span class="line">Verification error: unable to verify the first certificate</span><br><span class="line">---</span><br></pre></td></tr></table></figure></li></ol><a id="more"></a> <ol start="3"><li><p>根據輸出我們知道是 <code>certificate chain</code> 斷了無法驗證上游， 利用以下指令將 <code>domain cert</code> 與 <code>intermediate cert</code> 重新合併</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat domain.crt gd_bundle-g2-g1.crt &gt; combined_domain.crt</span><br></pre></td></tr></table></figure></li><li><p>到 web server 將合併過後的 certificate 替換上去，重新測試後就可以發現 <code>certificate chain</code> 重新接上了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">Certificate chain</span><br><span class="line"> 0 s:OU &#x3D; Domain Control Validated, CN &#x3D; *.example.com</span><br><span class="line">   i:C &#x3D; US, ST &#x3D; Arizona, L &#x3D; Scottsdale, O &#x3D; &quot;GoDaddy.com, Inc.&quot;, OU &#x3D; http:&#x2F;&#x2F;certs.godaddy.com&#x2F;repository&#x2F;, CN &#x3D; Go Daddy Secure Certificate Authority - G2</span><br><span class="line"> 1 s:C &#x3D; US, ST &#x3D; Arizona, L &#x3D; Scottsdale, O &#x3D; &quot;GoDaddy.com, Inc.&quot;, OU &#x3D; http:&#x2F;&#x2F;certs.godaddy.com&#x2F;repository&#x2F;, CN &#x3D; Go Daddy Secure Certificate Authority - G2</span><br><span class="line">   i:C &#x3D; US, ST &#x3D; Arizona, L &#x3D; Scottsdale, O &#x3D; &quot;GoDaddy.com, Inc.&quot;, CN &#x3D; Go Daddy Root Certificate Authority - G2</span><br><span class="line"> 2 s:C &#x3D; US, ST &#x3D; Arizona, L &#x3D; Scottsdale, O &#x3D; &quot;GoDaddy.com, Inc.&quot;, CN &#x3D; Go Daddy Root Certificate Authority - G2</span><br><span class="line">   i:C &#x3D; US, O &#x3D; &quot;The Go Daddy Group, Inc.&quot;, OU &#x3D; Go Daddy Class 2 Certification Authority</span><br><span class="line"> 3 s:C &#x3D; US, O &#x3D; &quot;The Go Daddy Group, Inc.&quot;, OU &#x3D; Go Daddy Class 2 Certification Authority</span><br><span class="line">   i:C &#x3D; US, O &#x3D; &quot;The Go Daddy Group, Inc.&quot;, OU &#x3D; Go Daddy Class 2 Certification Authority</span><br><span class="line">---</span><br><span class="line">SSL handshake has read 5709 bytes and written 420 bytes</span><br><span class="line">Verification: OK</span><br><span class="line">---</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;ol&gt;
&lt;li&gt;&lt;p&gt;利用 openssl-cli 來測試目標 domain&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;openssl s_client -connect example.com:443&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;檢視輸出訊息，會顯示 &lt;code&gt;Certificate chain&lt;/code&gt;、&lt;code&gt;Server certificate&lt;/code&gt;、&lt;code&gt;Verification&lt;/code&gt;、&lt;code&gt;SSL handshake&lt;/code&gt; 等資訊&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Certificate chain&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; 0 s:OU &amp;#x3D; Domain Control Validated, CN &amp;#x3D; *.example.com&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   i:C &amp;#x3D; US, ST &amp;#x3D; Arizona, L &amp;#x3D; Scottsdale, O &amp;#x3D; &amp;quot;GoDaddy.com, Inc.&amp;quot;, OU &amp;#x3D; http:&amp;#x2F;&amp;#x2F;certs.godaddy.com&amp;#x2F;repository&amp;#x2F;, CN &amp;#x3D; Go Daddy Secure Certificate Authority - G2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SSL handshake has read 2283 bytes and written 420 bytes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Verification error: unable to verify the first certificate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.downager.com/categories/Linux/"/>
    
    
      <category term="除錯" scheme="https://blog.downager.com/tags/%E9%99%A4%E9%8C%AF/"/>
    
      <category term="SSL" scheme="https://blog.downager.com/tags/SSL/"/>
    
  </entry>
  
  <entry>
    <title>[DevOps] 利用 Jenkins 與 Ansible 搭建 CI/CD Pipeline</title>
    <link href="https://blog.downager.com/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/"/>
    <id>https://blog.downager.com/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/</id>
    <published>2020-01-31T09:12:17.000Z</published>
    <updated>2020-11-19T05:50:50.475Z</updated>
    
    <content type="html"><![CDATA[<h1 id="簡易-CI-CD-Pipeline-設計原則"><a href="#簡易-CI-CD-Pipeline-設計原則" class="headerlink" title="簡易 CI/CD Pipeline 設計原則"></a>簡易 CI/CD Pipeline 設計原則</h1><p><a href="https://github.com/Downager/flask-realworld-example-app" target="_blank" rel="noopener">範例用 GitHub Repository</a></p><ol><li>遵循 GitHub Flow，<code>master</code> 分支永遠是經過驗證且可佈署的</li><li>建立新 <code>Pull Request</code> 時，自動 deploy 到 Staging 環境並執行 <code>Smoke Testing</code>，等團隊其他成員或主管完成 <code>Code Review</code> 以及測試後才能 <code>Merge</code> 至 <code>master</code></li><li>只有被 <code>Tag</code> 的 commit，才能 deploy 到 Production 環境（手動）</li><li>為了方便測試，可以手動 deploy 其他 branch 到 Staging 環境</li></ol><h1 id="Pipeline-設定"><a href="#Pipeline-設定" class="headerlink" title="Pipeline 設定"></a>Pipeline 設定</h1><h2 id="Jenkinsfile-說明"><a href="#Jenkinsfile-說明" class="headerlink" title="Jenkinsfile 說明"></a><a href="https://github.com/Downager/flask-realworld-example-app/blob/master/Jenkinsfile" target="_blank" rel="noopener">Jenkinsfile</a> 說明</h2><ol><li><p>全域環境變數設定</p> <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">environment &#123;</span><br><span class="line">    # 登入 Docker Hub 的 credential</span><br><span class="line">    DOCKER_HUB_CREDS = credentials(<span class="string">'dockerhub-downager'</span>)</span><br><span class="line">    # 設定 Staging 和 Production 環境 Postgresql UserName &amp; Password</span><br><span class="line">    FLASK_POSTGRES_CREDS = credentials(<span class="string">'flask-app-postgres-user-pass'</span>)</span><br><span class="line">    # 決定本次佈署是否要執行 db_migrate.sh 這隻腳本</span><br><span class="line">    DB_MIGRATION = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a> </li><li><p>在 Jenkins Node 上 build 出 UnitTest 專用的 docker image，並進行測試</p> <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    sh <span class="string">'docker build -t flask-realworld-example-app:UnitTest -f ./UnitTest_Dockerfile .'</span></span><br><span class="line">    sh <span class="string">'docker run flask-realworld-example-app:UnitTest'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Build 出 Production 專用的 Image，並推至 Private Docker Registry，並用 <code>COMMIT_ID</code> 當作 Image Tag</p> <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    sh <span class="string">'docker login -u $DOCKER_HUB_CREDS_USR -p $DOCKER_HUB_CREDS_PSW'</span></span><br><span class="line">    sh <span class="string">'docker build -t downager/flask-realworld-example-app:$GIT_COMMIT .'</span></span><br><span class="line">    sh <span class="string">'docker push downager/flask-realworld-example-app:$GIT_COMMIT'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>每次觸發 Jenkins Job 時都會佈署至 Staging 環境，並執行 Smoke Testing</p> <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'Deploy - Staging'</span>) &#123;</span><br><span class="line">  environment &#123;</span><br><span class="line">    # 設定本次 Ansible Playbook 要執行的 Host Group</span><br><span class="line">    HOST_GROUP = <span class="string">'Staging'</span></span><br><span class="line">    # 設定本次 docker-compose 的 image tag，Staging 環境是 COMMIT_ID</span><br><span class="line">    IMAGE_TAG = sh(<span class="string">returnStdout:</span> <span class="literal">true</span>, <span class="string">script:</span> <span class="string">'echo $GIT_COMMIT'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  steps &#123;</span><br><span class="line">    echo <span class="string">'Deploy to staging servers'</span></span><br><span class="line">    ansiColor(<span class="string">colorMapName:</span> <span class="string">'xterm'</span>) &#123;</span><br><span class="line">      ansiblePlaybook(</span><br><span class="line"><span class="symbol">        disableHostKeyChecking:</span> <span class="literal">true</span>,</span><br><span class="line">        # 設定登入 Staging 環境的 SSH KEY</span><br><span class="line"><span class="symbol">        credentialsId:</span> <span class="string">'devops-ssh-key'</span>,</span><br><span class="line"><span class="symbol">        playbook:</span> <span class="string">'ansible/playbook-deploy-flask-app.yml'</span>,</span><br><span class="line"><span class="symbol">        inventory:</span> <span class="string">'ansible/hosts'</span>,</span><br><span class="line"><span class="symbol">        colorized:</span> <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    echo <span class="string">'Make a smoke testing on staging servers (MAX_RETRIES = 3)'</span></span><br><span class="line">    # 進行 Smoke Testing，如果連續三次都失敗才報錯退出</span><br><span class="line">    retry(<span class="number">3</span>) &#123;</span><br><span class="line">      ansiColor(<span class="string">colorMapName:</span> <span class="string">'xterm'</span>) &#123;</span><br><span class="line">        ansiblePlaybook(</span><br><span class="line"><span class="symbol">          disableHostKeyChecking:</span> <span class="literal">true</span>,</span><br><span class="line">          # 設定登入 Staging 環境的 SSH KEY</span><br><span class="line"><span class="symbol">          credentialsId:</span> <span class="string">'devops-ssh-key'</span>,</span><br><span class="line"><span class="symbol">          playbook:</span> <span class="string">'ansible/playbook-smoke-testing.yml'</span>,</span><br><span class="line"><span class="symbol">          inventory:</span> <span class="string">'ansible/hosts'</span>,</span><br><span class="line"><span class="symbol">          colorized:</span> <span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>佈署至 Production 環境，只有觸發帶 <code>Tag</code> 的 Job 才會執行此階段</p> <img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/001.png" class=""> <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'Deploy - Production'</span>) &#123;</span><br><span class="line">  when &#123;</span><br><span class="line">    tag <span class="string">'*'</span></span><br><span class="line">  &#125;</span><br><span class="line">  environment &#123;</span><br><span class="line">    # 設定本次 Ansible Playbook 要執行的 Host Group</span><br><span class="line">    HOST_GROUP = <span class="string">'Production'</span></span><br><span class="line">    # 設定本次 docker-compose 的 image tag，Production 環境是 Git tag</span><br><span class="line">    IMAGE_TAG = sh(<span class="string">returnStdout:</span> <span class="literal">true</span>, <span class="string">script:</span> <span class="string">'echo $TAG_NAME'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  steps &#123;</span><br><span class="line">    echo <span class="string">'Deploying only because this commit is tagged'</span></span><br><span class="line">    # 將本次 commit 的 image 打上 Git Tag，並推上 docker registry</span><br><span class="line">    sh <span class="string">'docker tag downager/flask-realworld-example-app:$GIT_COMMIT downager/flask-realworld-example-app:$TAG_NAME'</span></span><br><span class="line">    sh <span class="string">'docker push downager/flask-realworld-example-app:$TAG_NAME'</span></span><br><span class="line">    echo <span class="string">'Deploy to production servers'</span></span><br><span class="line">    ansiColor(<span class="string">colorMapName:</span> <span class="string">'xterm'</span>) &#123;</span><br><span class="line">      ansiblePlaybook(</span><br><span class="line"><span class="symbol">        disableHostKeyChecking:</span> <span class="literal">true</span>,</span><br><span class="line">        # 設定登入 Production 環境的 SSH KEY</span><br><span class="line"><span class="symbol">        credentialsId:</span> <span class="string">'devops-ssh-key'</span>,</span><br><span class="line"><span class="symbol">        playbook:</span> <span class="string">'ansible/playbook-deploy-flask-app.yml'</span>,</span><br><span class="line"><span class="symbol">        inventory:</span> <span class="string">'ansible/hosts'</span>,</span><br><span class="line"><span class="symbol">        colorized:</span> <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    echo <span class="string">'Make a smoke testing on production servers (MAX_RETRIES = 3)'</span></span><br><span class="line">    # 進行 Smoke Testing，如果連續三次都失敗才報錯退出</span><br><span class="line">    retry(<span class="number">3</span>) &#123;</span><br><span class="line">      ansiColor(<span class="string">colorMapName:</span> <span class="string">'xterm'</span>) &#123;</span><br><span class="line">        ansiblePlaybook(</span><br><span class="line"><span class="symbol">          disableHostKeyChecking:</span> <span class="literal">true</span>,</span><br><span class="line">          # 設定登入 Production 環境的 SSH KEY</span><br><span class="line"><span class="symbol">          credentialsId:</span> <span class="string">'devops-ssh-key'</span>,</span><br><span class="line"><span class="symbol">          playbook:</span> <span class="string">'ansible/playbook-smoke-testing.yml'</span>,</span><br><span class="line"><span class="symbol">          inventory:</span> <span class="string">'ansible/hosts'</span>,</span><br><span class="line"><span class="symbol">          colorized:</span> <span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Ansible-Playbook-說明"><a href="#Ansible-Playbook-說明" class="headerlink" title="Ansible Playbook 說明"></a>Ansible Playbook 說明</h2><h3 id="playbook-deploy-flask-app-yml"><a href="#playbook-deploy-flask-app-yml" class="headerlink" title="playbook-deploy-flask-app.yml"></a><a href="https://github.com/Downager/flask-realworld-example-app/blob/master/ansible/playbook-deploy-flask-app.yml" target="_blank" rel="noopener">playbook-deploy-flask-app.yml</a></h3></li><li><p>建立資料夾以及設定權限</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取得 Jenkinsfile 設定的 HOST_GROUP 環境變數，決定要 deploy 到 Staging 或 Production 環境</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">"<span class="template-variable">&#123;&#123; lookup('env','HOST_GROUP') &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">devops</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="comment"># 取得 DB_MIGRATION 環境變數，決定是否執行 DB migrate 步驟</span></span><br><span class="line">    <span class="attr">DB_MIGRATION:</span> <span class="string">"<span class="template-variable">&#123;&#123; lookup('env','DB_MIGRATION') &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Change</span> <span class="string">ownership</span> <span class="string">of</span> <span class="string">/opt</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/opt</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">devops</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">devops</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">"0775"</span></span><br><span class="line">      <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">flask-realworld-example-app</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/opt/flask-realworld-example-app</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">devops</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">devops</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">"0775"</span></span><br></pre></td></tr></table></figure></li><li><p>複製 <code>docker-compose.yaml</code>，以及將 container 所需環境變數寫入 <code>.env</code> 內</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">docker-compose</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">docker-compose.yaml</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/opt/flask-realworld-example-app</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">.env</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">copy:</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/opt/flask-realworld-example-app/.env</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">TAG=&#123;&#123;</span> <span class="string">lookup('env','IMAGE_TAG')</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">POSTGRES_USER=&#123;&#123;</span> <span class="string">lookup('env','FLASK_POSTGRES_CREDS_USR')</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">POSTGRES_PASSWORD=&#123;&#123;</span> <span class="string">lookup('env','FLASK_POSTGRES_CREDS_PSW')</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>登入 Private Docker Registry，以及使用 docker-compose 管理容器編排</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Log</span> <span class="string">into</span> <span class="string">DockerHub</span></span><br><span class="line">      <span class="attr">docker_login:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; lookup('env','DOCKER_HUB_CREDS_USR') &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; lookup('env','DOCKER_HUB_CREDS_PSW') &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-compose</span> <span class="string">down</span> <span class="string">'flask-realworld-example-app'</span></span><br><span class="line">      <span class="attr">docker_compose:</span></span><br><span class="line">        <span class="attr">project_src:</span> <span class="string">/opt/flask-realworld-example-app</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">output</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-compose</span> <span class="string">up</span> <span class="string">'flask-realworld-example-app'</span></span><br><span class="line">      <span class="attr">docker_compose:</span></span><br><span class="line">        <span class="attr">project_src:</span> <span class="string">/opt/flask-realworld-example-app</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">        <span class="comment"># 強迫重新拉取 image</span></span><br><span class="line">        <span class="attr">pull:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">output</span></span><br></pre></td></tr></table></figure></li><li><p>根據環境變數設定決定是否執行 <code>./db_migrate.sh</code> 腳本</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB</span> <span class="string">migrate</span> <span class="bullet">-</span> <span class="string">flask-realworld-example-app</span> </span><br><span class="line">  <span class="attr">command:</span> <span class="string">docker</span> <span class="string">exec</span> <span class="string">flask-realworld-example-app</span> <span class="string">bash</span> <span class="string">-c</span> <span class="string">'./db_migrate.sh'</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">DB_MIGRATION</span> <span class="string">==</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="playbook-smoke-testing-yml"><a href="#playbook-smoke-testing-yml" class="headerlink" title="playbook-smoke-testing.yml"></a><a href="https://github.com/Downager/flask-realworld-example-app/blob/master/ansible/playbook-smoke-testing.yml" target="_blank" rel="noopener">playbook-smoke-testing.yml</a></h3><ul><li>登入到主機中，進行簡易的本機測試，只要回傳的不是 HTTP 200 就會報錯，退出 Jenkins Job  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取得 Jenkinsfile 設定的 HOST_GROUP 環境變數，決定要測試 Staging 或 Production 環境</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">"<span class="template-variable">&#123;&#123; lookup('env','HOST_GROUP') &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">devops</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">HOST_NAME:</span> <span class="string">"http://localhost:8080"</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET</span> <span class="string">'/api/tags'</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">"<span class="template-variable">&#123;&#123; HOST_NAME &#125;&#125;</span>/api/tags"</span></span><br><span class="line">        <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">        <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET</span> <span class="string">'/api/articles'</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">"<span class="template-variable">&#123;&#123; HOST_NAME &#125;&#125;</span>/api/articles"</span></span><br><span class="line">        <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">        <span class="attr">status_code:</span> <span class="number">200</span></span><br></pre></td></tr></table></figure><h2 id="docker-compose-說明"><a href="#docker-compose-說明" class="headerlink" title="docker-compose 說明"></a><a href="https://github.com/Downager/flask-realworld-example-app/blob/master/ansible/docker-compose.yaml" target="_blank" rel="noopener">docker-compose</a> 說明</h2></li><li><code>docker-compose.yaml</code> 上的環境變數設定，都是由 Ansible Playbook 寫入 <code>.env</code> 檔案中，如果需要人工介入重啟 docker-compose 時才不會缺少環境變數  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">flask-realworld-example-app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">downager/flask-realworld-example-app:$&#123;TAG&#125;</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">DATABASE_URL=postgresql://$&#123;POSTGRES_USER&#125;:$&#123;POSTGRES_PASSWORD&#125;@db/flask-app</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./app/migrations:/app/migrations</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:12.1</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=$&#123;POSTGRES_USER:-postgres&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD=$&#123;POSTGRES_PASSWORD:-changeme&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_DB=flask-app</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pgdata:/var/lib/postgresql/data/</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5432</span><span class="string">:5432</span>  </span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line"><span class="attr">networks:</span> </span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">pgdata:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br></pre></td></tr></table></figure><h1 id="Jenkins-amp-GitHub-設定"><a href="#Jenkins-amp-GitHub-設定" class="headerlink" title="Jenkins &amp; GitHub 設定"></a>Jenkins &amp; GitHub 設定</h1></li></ul><ol><li><p>請先參考本篇進行初步設定：<br><a href="https://blog.yowko.com/github-plugin-jenkins-webhook/" target="_blank" rel="noopener">GitHub Repository 有變動時自動通知 Jenkins 2 進行編譯建置 (GitHub Plugin)</a></p></li><li><p>調整 GitHub Webhook 設定，只勾選<code>Branch or tag creation / deletion</code>、<code>Pull requests</code>、<code>Pushes</code></p><img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/002.png" class=""></li><li><p>回到 Jenkins，設定 <code>Discover tags</code></p><img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/003.png" class=""></li><li><p>設定預設行為 <code>Suppress automatic SCM triggering</code>，只有 <code>master</code> 和 <code>Pull Requests</code> 觸發 Jenkins Job</p><img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/004.png" class=""></li></ol><h1 id="成果截圖"><a href="#成果截圖" class="headerlink" title="成果截圖"></a>成果截圖</h1><ul><li><p>當新的 Pull Request 建立時，會自動 Trigger Jenkins 執行測試，以及回報結果至 GitHub PR 上</p> <img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/005.png" class=""> <img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/006.png" class=""></li><li><p>只有帶 <code>Tag</code> 的事件才會進入 <code>Deploy - Production</code> 階段</p> <img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/007.png" class=""></li><li><p>Ansible Playbook 執行截圖</p> <img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/008.png" class=""></li><li><p>Jenkins BlueOcean 截圖</p> <img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/009.png" class=""></li><li><p>Jenkins Stage View</p> <img src="/2020/01/31/DevOps-%E5%88%A9%E7%94%A8-Jenkins-%E8%88%87-Ansible-%E6%90%AD%E5%BB%BA-CI-CD-Pipeline/010.png" class=""></li></ul><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://jenkins.io/doc/book/pipeline/jenkinsfile/#handling-credentials" target="_blank" rel="noopener">Using a Jenkinsfile - Handling credentials</a></li><li><a href="https://jenkins.io/blog/2018/05/16/pipelines-with-git-tags/" target="_blank" rel="noopener">When using tags in Jenkins Pipeline</a></li><li><a href="https://medium.com/@dillson/triggering-a-jenkins-pipeline-on-git-push-321d29a98cf3" target="_blank" rel="noopener">Triggering a Jenkins Pipeline on ‘git push’</a></li><li><a href="https://www.redhat.com/en/blog/integrating-ansible-jenkins-cicd-process" target="_blank" rel="noopener">Integrating Ansible with Jenkins in a CI/CD process</a></li><li><a href="https://stackoverflow.com/questions/42798006/how-to-disable-automatic-build-from-scm-change-in-jenkinsfile" target="_blank" rel="noopener">How to disable automatic build from scm change in Jenkinsfile</a></li><li><a href="https://medium.com/appgambit/ansible-playbook-with-jenkins-pipeline-2846d4442a31" target="_blank" rel="noopener">Ansible Playbook with Jenkins Pipeline</a></li><li><a href="https://github.com/gothinkster/flask-realworld-example-app/pull/29/commits/13a1d0f112c386eb73a97b1c1b7aba8c7e39c5ac" target="_blank" rel="noopener">Fix unique constraint on userprofile.user_id #29</a></li><li><a href="https://blog.wu-boy.com/2017/12/github-flow-vs-git-flow/" target="_blank" rel="noopener">GitHub Flow 及 Git Flow 流程使用時機</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;簡易-CI-CD-Pipeline-設計原則&quot;&gt;&lt;a href=&quot;#簡易-CI-CD-Pipeline-設計原則&quot; class=&quot;headerlink&quot; title=&quot;簡易 CI/CD Pipeline 設計原則&quot;&gt;&lt;/a&gt;簡易 CI/CD Pipeline 設計原則&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/Downager/flask-realworld-example-app&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;範例用 GitHub Repository&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;遵循 GitHub Flow，&lt;code&gt;master&lt;/code&gt; 分支永遠是經過驗證且可佈署的&lt;/li&gt;
&lt;li&gt;建立新 &lt;code&gt;Pull Request&lt;/code&gt; 時，自動 deploy 到 Staging 環境並執行 &lt;code&gt;Smoke Testing&lt;/code&gt;，等團隊其他成員或主管完成 &lt;code&gt;Code Review&lt;/code&gt; 以及測試後才能 &lt;code&gt;Merge&lt;/code&gt; 至 &lt;code&gt;master&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;只有被 &lt;code&gt;Tag&lt;/code&gt; 的 commit，才能 deploy 到 Production 環境（手動）&lt;/li&gt;
&lt;li&gt;為了方便測試，可以手動 deploy 其他 branch 到 Staging 環境&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;Pipeline-設定&quot;&gt;&lt;a href=&quot;#Pipeline-設定&quot; class=&quot;headerlink&quot; title=&quot;Pipeline 設定&quot;&gt;&lt;/a&gt;Pipeline 設定&lt;/h1&gt;&lt;h2 id=&quot;Jenkinsfile-說明&quot;&gt;&lt;a href=&quot;#Jenkinsfile-說明&quot; class=&quot;headerlink&quot; title=&quot;Jenkinsfile 說明&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://github.com/Downager/flask-realworld-example-app/blob/master/Jenkinsfile&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Jenkinsfile&lt;/a&gt; 說明&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;全域環境變數設定&lt;/p&gt;
 &lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;environment &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # 登入 Docker Hub 的 credential&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DOCKER_HUB_CREDS = credentials(&lt;span class=&quot;string&quot;&gt;&#39;dockerhub-downager&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # 設定 Staging 和 Production 環境 Postgresql UserName &amp;amp; Password&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    FLASK_POSTGRES_CREDS = credentials(&lt;span class=&quot;string&quot;&gt;&#39;flask-app-postgres-user-pass&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # 決定本次佈署是否要執行 db_migrate.sh 這隻腳本&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DB_MIGRATION = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="DevOps" scheme="https://blog.downager.com/categories/DevOps/"/>
    
    
      <category term="Jenkins" scheme="https://blog.downager.com/tags/Jenkins/"/>
    
      <category term="CI/CD" scheme="https://blog.downager.com/tags/CI-CD/"/>
    
      <category term="Ansible" scheme="https://blog.downager.com/tags/Ansible/"/>
    
      <category term="Docker" scheme="https://blog.downager.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>[踩坑] fluentd daemonset failed to flush the buffer</title>
    <link href="https://blog.downager.com/2019/11/24/%E8%B8%A9%E5%9D%91-fluentd-daemonset-failed-to-flush-the-buffer/"/>
    <id>https://blog.downager.com/2019/11/24/%E8%B8%A9%E5%9D%91-fluentd-daemonset-failed-to-flush-the-buffer/</id>
    <published>2019-11-23T18:02:35.000Z</published>
    <updated>2020-11-19T05:50:50.475Z</updated>
    
    <content type="html"><![CDATA[<h1 id="除錯紀錄"><a href="#除錯紀錄" class="headerlink" title="除錯紀錄"></a>除錯紀錄</h1><p>最近同事抱怨 elasticsearch 常常掉資料，請我幫忙檢查下 ES 是不是有問題，看了下 cluster 的健康狀態也正常，node 硬碟剩餘空間也都還不少，手動打了下也有資料，實在摸不著頭緒。回頭往資料源頭查，<code>kubectl logs &lt;application_pod&gt;</code> 看了下也都有正常吐 log 到 stdout，往上檢查到 fluentd 時發現不太對勁，<code>kubectl logs &lt;fluentd_pod&gt; | grep -v info</code> 看了下發現報了 Warning：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-11-17 05:07:05 +0000 [warn]: #0 failed to write data into buffer by buffer overflow action&#x3D;:block</span><br><span class="line">2019-11-17 05:24:05 +0000 [warn]: #0 failed to flush the buffer. retry_time&#x3D;3 next_retry_seconds&#x3D;2019-11-17 05:24:32 +0000 chunk&#x3D;&quot;59778cb47a5c5dcf401f4d1c5b2cc88f&quot; error_class&#x3D;Fluent::Plugin::ElasticsearchOutput::RecoverableRequestFailure error&#x3D;&quot;could not push logs to Elasticsearch cluster (&#123;:host&#x3D;&gt;\&quot;&lt;elastic_cluster&gt;\&quot;, :port&#x3D;&gt;9200, :scheme&#x3D;&gt;\&quot;http\&quot;, :user&#x3D;&gt;\&quot;elastic\&quot;, :password&#x3D;&gt;\&quot;obfuscated\&quot;, :path&#x3D;&gt;\&quot;\&quot;&#125;): connect_write timeout reached&quot;</span><br></pre></td></tr></table></figure><p>初步檢查看起來是 Buffer 炸掉了，調整一下 Buffer Size 先，順便把 timeout 時間拉長點觀察看看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buffer_chunk_limit &quot;#&#123;ENV[&#39;FLUENT_ELASTICSEARCH_BUFFER_CHUNK_LIMIT_SIZE&#39;] || &#39;8M&#39;&#125;&quot;</span><br><span class="line">buffer_queue_limit &quot;#&#123;ENV[&#39;FLUENT_ELASTICSEARCH_BUFFER_QUEUE_LIMIT_LENGTH&#39;] || &#39;256&#39;&#125;&quot;</span><br><span class="line">request_timeout 15s</span><br></pre></td></tr></table></figure><p>隔天看 Log 還是炸掉，後來仔細爬了一下才發現有人提過這個 Issue: <a href="https://github.com/uken/fluent-plugin-elasticsearch/issues/525" target="_blank" rel="noopener">Fluentd stopped sending data to ES for somewhile. #525</a></p><a id="more"></a> <p>官方其實 FAQ 就有寫了 XD</p><blockquote><p><a href="https://github.com/uken/fluent-plugin-elasticsearch#stopped-to-send-events-on-k8s-why" target="_blank" rel="noopener">Stopped to send events on k8s, why?</a><br>fluent-plugin-elasticsearch reloads connection after 10000 requests. (Not correspond to events counts because ES plugin uses bulk API.)<br>This functionality which is originated from elasticsearch-ruby gem is enabled by default.<br>Sometimes this reloading functionality bothers users to send events with ES plugin.<br>On k8s platform, users sometimes shall specify the following settings:</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reload_connections false</span><br><span class="line">reconnect_on_error true</span><br><span class="line">reload_on_failure true</span><br></pre></td></tr></table></figure><p>調整完後就沒有 timeout 過了，總算搞定了這問題。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;除錯紀錄&quot;&gt;&lt;a href=&quot;#除錯紀錄&quot; class=&quot;headerlink&quot; title=&quot;除錯紀錄&quot;&gt;&lt;/a&gt;除錯紀錄&lt;/h1&gt;&lt;p&gt;最近同事抱怨 elasticsearch 常常掉資料，請我幫忙檢查下 ES 是不是有問題，看了下 cluster 的健康狀態也正常，node 硬碟剩餘空間也都還不少，手動打了下也有資料，實在摸不著頭緒。回頭往資料源頭查，&lt;code&gt;kubectl logs &amp;lt;application_pod&amp;gt;&lt;/code&gt; 看了下也都有正常吐 log 到 stdout，往上檢查到 fluentd 時發現不太對勁，&lt;code&gt;kubectl logs &amp;lt;fluentd_pod&amp;gt; | grep -v info&lt;/code&gt; 看了下發現報了 Warning：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;2019-11-17 05:07:05 +0000 [warn]: #0 failed to write data into buffer by buffer overflow action&amp;#x3D;:block&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2019-11-17 05:24:05 +0000 [warn]: #0 failed to flush the buffer. retry_time&amp;#x3D;3 next_retry_seconds&amp;#x3D;2019-11-17 05:24:32 +0000 chunk&amp;#x3D;&amp;quot;59778cb47a5c5dcf401f4d1c5b2cc88f&amp;quot; error_class&amp;#x3D;Fluent::Plugin::ElasticsearchOutput::RecoverableRequestFailure error&amp;#x3D;&amp;quot;could not push logs to Elasticsearch cluster (&amp;#123;:host&amp;#x3D;&amp;gt;\&amp;quot;&amp;lt;elastic_cluster&amp;gt;\&amp;quot;, :port&amp;#x3D;&amp;gt;9200, :scheme&amp;#x3D;&amp;gt;\&amp;quot;http\&amp;quot;, :user&amp;#x3D;&amp;gt;\&amp;quot;elastic\&amp;quot;, :password&amp;#x3D;&amp;gt;\&amp;quot;obfuscated\&amp;quot;, :path&amp;#x3D;&amp;gt;\&amp;quot;\&amp;quot;&amp;#125;): connect_write timeout reached&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;初步檢查看起來是 Buffer 炸掉了，調整一下 Buffer Size 先，順便把 timeout 時間拉長點觀察看看&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;buffer_chunk_limit &amp;quot;#&amp;#123;ENV[&amp;#39;FLUENT_ELASTICSEARCH_BUFFER_CHUNK_LIMIT_SIZE&amp;#39;] || &amp;#39;8M&amp;#39;&amp;#125;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;buffer_queue_limit &amp;quot;#&amp;#123;ENV[&amp;#39;FLUENT_ELASTICSEARCH_BUFFER_QUEUE_LIMIT_LENGTH&amp;#39;] || &amp;#39;256&amp;#39;&amp;#125;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;request_timeout 15s&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;隔天看 Log 還是炸掉，後來仔細爬了一下才發現有人提過這個 Issue: &lt;a href=&quot;https://github.com/uken/fluent-plugin-elasticsearch/issues/525&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Fluentd stopped sending data to ES for somewhile. #525&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Cloud-Native" scheme="https://blog.downager.com/categories/Cloud-Native/"/>
    
    
      <category term="kubernetes" scheme="https://blog.downager.com/tags/kubernetes/"/>
    
      <category term="fluentd" scheme="https://blog.downager.com/tags/fluentd/"/>
    
      <category term="elasticsearch" scheme="https://blog.downager.com/tags/elasticsearch/"/>
    
      <category term="踩坑" scheme="https://blog.downager.com/tags/%E8%B8%A9%E5%9D%91/"/>
    
      <category term="除錯" scheme="https://blog.downager.com/tags/%E9%99%A4%E9%8C%AF/"/>
    
  </entry>
  
  <entry>
    <title>[隨筆] Install Linux Mint 19.2 on Dell Inspiron 7375</title>
    <link href="https://blog.downager.com/2019/11/10/%E9%9A%A8%E7%AD%86-Install-Linux-Mint-19-2-on-Dell-Inspiron-7375/"/>
    <id>https://blog.downager.com/2019/11/10/%E9%9A%A8%E7%AD%86-Install-Linux-Mint-19-2-on-Dell-Inspiron-7375/</id>
    <published>2019-11-10T09:30:00.000Z</published>
    <updated>2020-11-19T05:50:50.475Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近搞了台 Ryzen 筆電來跑 Linux，筆記下安裝上的細節</p><h1 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h1><ol><li><p>安裝部份就跳過了，開機後到 Grub 選單時，按 <code>e</code> 編輯開機選項，找到 <code>Linux</code> 開頭那行，移除 <code>quite</code>，加上 <code>noapic noacpi irqpoll</code></p></li><li><p>登入後，打開 <code>Update Manager</code> &gt; <code>View</code> &gt; <code>Linux Kernels</code> 選擇最新的穩定版 (當前是 <code>5.3.0-19</code>)並安裝</p></li><li><p>打開 <code>Terminal</code>，編輯 <code>/etc/default/grub</code>，修改成以下資訊：</p><ol><li><code>sudo vi /etc/default/grub</code> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT&#x3D;&quot;amd_iommu&#x3D;on ivrs_ioapic[4]&#x3D;00:14.0 ivrs_ioapic[5]&#x3D;00:00.2 splash&quot;</span><br></pre></td></tr></table></figure><ul><li><code>2020-05-15 Update:</code> 改用以下這段，忘了從哪邊抄來的，系統比較不會凍結<br><code>kernel: 5.3.0-40-generic</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT&#x3D;&quot;vga&#x3D;current ivrs_ioapic[4]&#x3D;00:14.0 ivrs_ioapic[5]&#x3D;00:00.2 iommu&#x3D;pt idle&#x3D;nomwait acpi_backlight&#x3D;vendor acpi_enforce_resources&#x3D;lax scsi_mod.use_blk_mq&#x3D;1&quot;</span><br></pre></td></tr></table></figure></li></ul></li><li><code>sudo update-grub</code><a id="more"></a> </li></ol></li><li><p>更改預設的中文字體<br> <code>sudo vi /etc/fonts/conf.avail/64-language-selector-prefer.conf</code></p><pre><code class="xml"><span class="meta">&lt;?xml version="1.0"?&gt;</span><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">fontconfig</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"fonts.dtd"</span>&gt;</span><span class="tag">&lt;<span class="name">fontconfig</span>&gt;</span>    <span class="tag">&lt;<span class="name">alias</span>&gt;</span>        <span class="tag">&lt;<span class="name">family</span>&gt;</span>sans-serif<span class="tag">&lt;/<span class="name">family</span>&gt;</span>        <span class="tag">&lt;<span class="name">prefer</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans CJK TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans CJK SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans CJK JP<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans CJK KR<span class="tag">&lt;/<span class="name">family</span>&gt;</span>        <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span>    <span class="tag">&lt;/<span class="name">alias</span>&gt;</span>    <span class="tag">&lt;<span class="name">alias</span>&gt;</span>        <span class="tag">&lt;<span class="name">family</span>&gt;</span>serif<span class="tag">&lt;/<span class="name">family</span>&gt;</span>        <span class="tag">&lt;<span class="name">prefer</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Serif CJK TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Serif CJK SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Serif CJK JP<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Serif CJK KR<span class="tag">&lt;/<span class="name">family</span>&gt;</span>        <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span>    <span class="tag">&lt;/<span class="name">alias</span>&gt;</span>    <span class="tag">&lt;<span class="name">alias</span>&gt;</span>        <span class="tag">&lt;<span class="name">family</span>&gt;</span>monospace<span class="tag">&lt;/<span class="name">family</span>&gt;</span>        <span class="tag">&lt;<span class="name">prefer</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans Mono CJK TC<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans Mono CJK SC<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans Mono CJK JP<span class="tag">&lt;/<span class="name">family</span>&gt;</span>            <span class="tag">&lt;<span class="name">family</span>&gt;</span>Noto Sans Mono CJK KR<span class="tag">&lt;/<span class="name">family</span>&gt;</span>        <span class="tag">&lt;/<span class="name">prefer</span>&gt;</span>    <span class="tag">&lt;/<span class="name">alias</span>&gt;</span><span class="tag">&lt;/<span class="name">fontconfig</span>&gt;</span>cd /etc/fonts/conf.dsudo ln -s ../conf.avail/64-language-selector-prefer.conf 64-language-selector-prefer.conf</code></pre></li><li><p>重新開機</p></li></ol><h1 id="額外調整"><a href="#額外調整" class="headerlink" title="額外調整"></a>額外調整</h1><ol><li>停用觸控螢幕<ul><li><code>xinput list</code> 找到觸控螢幕 ID </li><li><code>xinput disable &lt;ID&gt;</code></li></ul></li></ol><h1 id="參考資訊"><a href="#參考資訊" class="headerlink" title="參考資訊"></a>參考資訊</h1><ul><li><a href="https://www.gottahavacuppamocha.com/2019/09/13/installing-linux-mint-19-2-on-a-dell-inspiron-13-7375-2-in-1/" target="_blank" rel="noopener">Installing Linux Mint 19.2 on a Dell Inspiron 13 7375 2-in-1</a></li><li><a href="https://wiki.archlinux.org/index.php/Dell_Inspiron_7375#Troubleshooting" target="_blank" rel="noopener">Arch linux Dell Inspiron 7375</a></li><li><a href="https://forums.linuxmint.com/viewtopic.php?t=277544" target="_blank" rel="noopener">default Chinese font changed in LM 19, very hard to read - where can I configure it</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;最近搞了台 Ryzen 筆電來跑 Linux，筆記下安裝上的細節&lt;/p&gt;
&lt;h1 id=&quot;安裝步驟&quot;&gt;&lt;a href=&quot;#安裝步驟&quot; class=&quot;headerlink&quot; title=&quot;安裝步驟&quot;&gt;&lt;/a&gt;安裝步驟&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;安裝部份就跳過了，開機後到 Grub 選單時，按 &lt;code&gt;e&lt;/code&gt; 編輯開機選項，找到 &lt;code&gt;Linux&lt;/code&gt; 開頭那行，移除 &lt;code&gt;quite&lt;/code&gt;，加上 &lt;code&gt;noapic noacpi irqpoll&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;登入後，打開 &lt;code&gt;Update Manager&lt;/code&gt; &amp;gt; &lt;code&gt;View&lt;/code&gt; &amp;gt; &lt;code&gt;Linux Kernels&lt;/code&gt; 選擇最新的穩定版 (當前是 &lt;code&gt;5.3.0-19&lt;/code&gt;)並安裝&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;打開 &lt;code&gt;Terminal&lt;/code&gt;，編輯 &lt;code&gt;/etc/default/grub&lt;/code&gt;，修改成以下資訊：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;sudo vi /etc/default/grub&lt;/code&gt; &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;GRUB_CMDLINE_LINUX_DEFAULT&amp;#x3D;&amp;quot;amd_iommu&amp;#x3D;on ivrs_ioapic[4]&amp;#x3D;00:14.0 ivrs_ioapic[5]&amp;#x3D;00:00.2 splash&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;2020-05-15 Update:&lt;/code&gt; 改用以下這段，忘了從哪邊抄來的，系統比較不會凍結&lt;br&gt;&lt;code&gt;kernel: 5.3.0-40-generic&lt;/code&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;GRUB_CMDLINE_LINUX_DEFAULT&amp;#x3D;&amp;quot;vga&amp;#x3D;current ivrs_ioapic[4]&amp;#x3D;00:14.0 ivrs_ioapic[5]&amp;#x3D;00:00.2 iommu&amp;#x3D;pt idle&amp;#x3D;nomwait acpi_backlight&amp;#x3D;vendor acpi_enforce_resources&amp;#x3D;lax scsi_mod.use_blk_mq&amp;#x3D;1&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sudo update-grub&lt;/code&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.downager.com/categories/Linux/"/>
    
    
      <category term="隨筆" scheme="https://blog.downager.com/tags/%E9%9A%A8%E7%AD%86/"/>
    
      <category term="Mint" scheme="https://blog.downager.com/tags/Mint/"/>
    
  </entry>
  
  <entry>
    <title>[CentOS] Zabbix + Grafana 安裝</title>
    <link href="https://blog.downager.com/2019/05/29/CentOS-Zabbix-Grafana-%E5%AE%89%E8%A3%9D/"/>
    <id>https://blog.downager.com/2019/05/29/CentOS-Zabbix-Grafana-%E5%AE%89%E8%A3%9D/</id>
    <published>2019-05-29T10:26:30.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Zabbix-安裝步驟"><a href="#Zabbix-安裝步驟" class="headerlink" title="Zabbix 安裝步驟"></a>Zabbix 安裝步驟</h2><p><strong>安裝環境：CentOS 7</strong></p><p><strong>1. 關閉 SELINUX</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line"></span><br><span class="line">## 將 SELINUX 修改為 disabled ##</span><br><span class="line">config&gt;SELINUX&#x3D;disabled</span><br><span class="line"></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><p><strong>2. 安裝 Zabbix 4.0 LTS</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh https:&#x2F;&#x2F;repo.zabbix.com&#x2F;zabbix&#x2F;4.0&#x2F;rhel&#x2F;7&#x2F;x86_64&#x2F;zabbix-release-4.0-1.el7.noarch.rpm</span><br><span class="line">yum clean all</span><br><span class="line">yum install zabbix-server-mysql zabbix-web-mysql zabbix-agent</span><br></pre></td></tr></table></figure><a id="more"></a><p><strong>3. 若沒有安裝 MySQL 或 Maria DB，請按照以下步驟安裝 Maria DB</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;yum.repos.d&#x2F;MariaDB.repo</span><br></pre></td></tr></table></figure><p>貼上以下內容（根據需求參考以下網址調整　<a href="http://downloads.mariadb.org/mariadb/repositories/" target="_blank" rel="noopener">http://downloads.mariadb.org/mariadb/repositories/</a> ）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># MariaDB 10.3 CentOS repository list - created 2019-05-28 01:56 UTC</span><br><span class="line"># http:&#x2F;&#x2F;downloads.mariadb.org&#x2F;mariadb&#x2F;repositories&#x2F;</span><br><span class="line">[mariadb]</span><br><span class="line">name &#x3D; MariaDB</span><br><span class="line">baseurl &#x3D; http:&#x2F;&#x2F;yum.mariadb.org&#x2F;10.3&#x2F;centos7-amd64</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;yum.mariadb.org&#x2F;RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck&#x3D;1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install MariaDB-server MariaDB-client</span><br></pre></td></tr></table></figure><p><strong>4. 啟動 MariaDB 並設定開機啟動</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br><span class="line">systemctl enable mariadb</span><br></pre></td></tr></table></figure><p><strong>5. 設定 MariaDB root 密碼</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;mysqladmin -u root password &#39;new-password&#39;</span><br></pre></td></tr></table></figure><p><strong>6. MariaDB 安全性設定</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;mysql_secure_installation</span><br></pre></td></tr></table></figure><p><strong>7. 建立 Zabbix 用帳號 &amp; Database</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">Enter password:</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database zabbix character set utf8 collate utf8_bin;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">## 建立 zabbix 帳號，記得修改 &lt;password&gt; 並拿掉 &lt;&gt; ##</span><br><span class="line">MariaDB [(none)]&gt; CREATE USER &#39;zabbix&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;&lt;password&gt;&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; grant all privileges on zabbix.* to zabbix@localhost identified by &#39;zabbix&#39;;  </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure><p><strong>8. 將 Zabbix 初始 SQL 架構和數據導入 MariaDB</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zcat &#x2F;usr&#x2F;share&#x2F;doc&#x2F;zabbix-server-mysql*&#x2F;create.sql.gz | mysql -uzabbix -p zabbix</span><br></pre></td></tr></table></figure><p><strong>9. 編輯 zabbix_server.conf</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_server.conf</span><br><span class="line"></span><br><span class="line">## 將 DB 密碼設成剛剛 zabbix@localhost 所設定的 ##</span><br><span class="line">DBPassword&#x3D;&lt;password&gt;</span><br></pre></td></tr></table></figure><p><strong>10. 編輯 zabbix.conf</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;zabbix.conf</span><br><span class="line"></span><br><span class="line">## 將 timezone 修改為 Asia&#x2F;Taipei ##</span><br><span class="line">php_value date.timezone Asia&#x2F;Taipei</span><br></pre></td></tr></table></figure><p><strong>11. 重開服務並設定開機啟動</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart zabbix-server zabbix-agent httpd</span><br><span class="line">systemctl enable zabbix-server zabbix-agent httpd</span><br></pre></td></tr></table></figure><p><strong>12. 打開防火牆</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port&#x3D;10050&#x2F;tcp</span><br><span class="line">firewall-cmd --permanent --add-port&#x3D;10051&#x2F;tcp</span><br><span class="line">firewall-cmd --permanent --add-port&#x3D;80&#x2F;tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">systemctl restart firewalld</span><br></pre></td></tr></table></figure><p><strong>13. 打開 <code>http://server_ip_or_name/zabbix</code> 測試</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Default Username: Admin</span><br><span class="line">Default Password: zabbix</span><br></pre></td></tr></table></figure><h2 id="Grafana-安裝步驟"><a href="#Grafana-安裝步驟" class="headerlink" title="Grafana 安裝步驟"></a>Grafana 安裝步驟</h2><p><strong>1. 安裝 Grafana（<a href="https://grafana.com/grafana/download" target="_blank" rel="noopener">https://grafana.com/grafana/download</a> ）</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;dl.grafana.com&#x2F;oss&#x2F;release&#x2F;grafana-6.2.1-1.x86_64.rpm </span><br><span class="line">yum localinstall grafana-6.2.1-1.x86_64.rpm</span><br></pre></td></tr></table></figure><p><strong>2. 設定開機自動啟動 &amp; 啟動 Grafana</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable grafana-server</span><br><span class="line">systemctl start grafana-server</span><br></pre></td></tr></table></figure><p><strong>3. 打開防火牆</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port&#x3D;3000&#x2F;tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">systemctl restart firewalld</span><br></pre></td></tr></table></figure><p><strong>4. 打開 <code>http://server_ip_or_name:3000</code> 測試</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Default Username: admin</span><br><span class="line">Default Password: admin</span><br></pre></td></tr></table></figure><p><strong>5. 安裝 Zabbix Plugin</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install alexanderzobnin-zabbix-app</span><br><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure><p><strong>6. 增加 Data source</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">URL: http:&#x2F;&#x2F;localhost&#x2F;zabbix&#x2F;api_jsonrpc.php</span><br><span class="line">Username: Admin</span><br><span class="line">Password: zabbix</span><br></pre></td></tr></table></figure><img src="/2019/05/29/CentOS-Zabbix-Grafana-%E5%AE%89%E8%A3%9D/Data_source.png" class=""><p><strong>7. 新增 Dashboard 監控設備</strong><br>可以到這邊找模板 <a href="https://grafana.com/dashboards?category=zabbix" target="_blank" rel="noopener">https://grafana.com/dashboards?category=zabbix</a></p><img src="/2019/05/29/CentOS-Zabbix-Grafana-%E5%AE%89%E8%A3%9D/Dashboard.png" class=""><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://www.zabbix.com/documentation/current/manual/installation/install_from_packages/rhel_centos" target="_blank" rel="noopener">Zabbix Documentation 4.0</a></li><li><a href="https://ezbox.idv.tw/76/rhel-centos-7-yum-mariadb-10/" target="_blank" rel="noopener">RHEL / CentOS 7 用 yum 安裝 MariaDB 10.x</a></li><li><a href="https://www.opencli.com/mysql/mysql-add-new-users-databases-privileges" target="_blank" rel="noopener">MySQL 新增使用者及建立資料庫權限</a></li><li><a href="https://ithelp.ithome.com.tw/articles/10190611" target="_blank" rel="noopener">1-1.監控工具之一:Zabbix Server</a></li><li><a href="https://ithelp.ithome.com.tw/articles/10190837" target="_blank" rel="noopener">2-1.監控工具之二:Grafana</a></li><li><a href="http://benjr.tw/97973" target="_blank" rel="noopener">MariaDB 資料庫使用者登入權限</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Zabbix-安裝步驟&quot;&gt;&lt;a href=&quot;#Zabbix-安裝步驟&quot; class=&quot;headerlink&quot; title=&quot;Zabbix 安裝步驟&quot;&gt;&lt;/a&gt;Zabbix 安裝步驟&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;安裝環境：CentOS 7&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. 關閉 SELINUX&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;vim &amp;#x2F;etc&amp;#x2F;selinux&amp;#x2F;config&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;## 將 SELINUX 修改為 disabled ##&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;config&amp;gt;SELINUX&amp;#x3D;disabled&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;reboot&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;2. 安裝 Zabbix 4.0 LTS&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;rpm -Uvh https:&amp;#x2F;&amp;#x2F;repo.zabbix.com&amp;#x2F;zabbix&amp;#x2F;4.0&amp;#x2F;rhel&amp;#x2F;7&amp;#x2F;x86_64&amp;#x2F;zabbix-release-4.0-1.el7.noarch.rpm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum clean all&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install zabbix-server-mysql zabbix-web-mysql zabbix-agent&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.downager.com/categories/Linux/"/>
    
    
      <category term="CentOS" scheme="https://blog.downager.com/tags/CentOS/"/>
    
      <category term="Zabbix" scheme="https://blog.downager.com/tags/Zabbix/"/>
    
      <category term="Grafana" scheme="https://blog.downager.com/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>[隨筆] CentOS 7 常用指令筆記</title>
    <link href="https://blog.downager.com/2019/04/28/%E9%9A%A8%E7%AD%86-CentOS-7-%E5%B8%B8%E7%94%A8%E7%AD%86%E8%A8%98%E6%8C%87%E4%BB%A4/"/>
    <id>https://blog.downager.com/2019/04/28/%E9%9A%A8%E7%AD%86-CentOS-7-%E5%B8%B8%E7%94%A8%E7%AD%86%E8%A8%98%E6%8C%87%E4%BB%A4/</id>
    <published>2019-04-27T17:16:33.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<h3 id="更改-Hostname"><a href="#更改-Hostname" class="headerlink" title="更改 Hostname"></a>更改 Hostname</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname &lt;new_hostname&gt;</span><br></pre></td></tr></table></figure><h3 id="設定-IP"><a href="#設定-IP" class="headerlink" title="設定 IP"></a>設定 IP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 進入設定精靈</span><br><span class="line">nmtui</span><br><span class="line"></span><br><span class="line"># 重啟 network</span><br><span class="line">systemctl restart network</span><br><span class="line"></span><br><span class="line"># 檢查設定是否正確</span><br><span class="line">ip address</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="安裝-EPEL-Repository"><a href="#安裝-EPEL-Repository" class="headerlink" title="安裝 EPEL Repository"></a>安裝 EPEL Repository</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br></pre></td></tr></table></figure><h3 id="安裝-open-vm-tools"><a href="#安裝-open-vm-tools" class="headerlink" title="安裝 open-vm-tools"></a>安裝 open-vm-tools</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install open-vm-tools</span><br></pre></td></tr></table></figure><h3 id="停用-SSH-root-登入"><a href="#停用-SSH-root-登入" class="headerlink" title="停用 SSH root 登入"></a>停用 SSH root 登入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 編輯 sshd_config</span><br><span class="line">vim &#x2F;etc&#x2F;ssh&#x2F;sshd_config</span><br><span class="line"></span><br><span class="line"># 修改以下內容</span><br><span class="line">PermitRootLogin no</span><br><span class="line"></span><br><span class="line"># 重啟 sshd</span><br><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure><h3 id="yum-rollback-到安裝前的狀態"><a href="#yum-rollback-到安裝前的狀態" class="headerlink" title="yum rollback 到安裝前的狀態"></a>yum rollback 到安裝前的狀態</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看預計要退的版本號</span><br><span class="line">yum history</span><br><span class="line"></span><br><span class="line"># undo</span><br><span class="line">yum history undo 8</span><br></pre></td></tr></table></figure><h3 id="firewall-cmd"><a href="#firewall-cmd" class="headerlink" title="firewall-cmd"></a>firewall-cmd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 查看目前網卡套用的 Zone</span><br><span class="line">firewall-cmd --get-active-zones</span><br><span class="line"></span><br><span class="line"># 將服務或端口永久新增或移除</span><br><span class="line">firewall-cmd --zone&#x3D;public --permanent --add-service&#x3D;http</span><br><span class="line">firewall-cmd --zone&#x3D;public --permanent --add-port&#x3D;8080&#x2F;tcp</span><br><span class="line">firewall-cmd --zone&#x3D;public --permanent --remove-service&#x3D;http</span><br><span class="line">firewall-cmd --zone&#x3D;public --permanent --remove-port&#x3D;8080&#x2F;tcp</span><br><span class="line"></span><br><span class="line"># reload 防火牆來套用新規則</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"># 檢查設定</span><br><span class="line">firewall-cmd --list-all-zones</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;更改-Hostname&quot;&gt;&lt;a href=&quot;#更改-Hostname&quot; class=&quot;headerlink&quot; title=&quot;更改 Hostname&quot;&gt;&lt;/a&gt;更改 Hostname&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;hostnamectl set-hostname &amp;lt;new_hostname&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;設定-IP&quot;&gt;&lt;a href=&quot;#設定-IP&quot; class=&quot;headerlink&quot; title=&quot;設定 IP&quot;&gt;&lt;/a&gt;設定 IP&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# 進入設定精靈&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nmtui&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 重啟 network&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl restart network&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 檢查設定是否正確&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ip address&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.downager.com/categories/Linux/"/>
    
    
      <category term="隨筆" scheme="https://blog.downager.com/tags/%E9%9A%A8%E7%AD%86/"/>
    
      <category term="CentOS" scheme="https://blog.downager.com/tags/CentOS/"/>
    
  </entry>
  
  <entry>
    <title>[隨筆] VMWare ESXi 筆記</title>
    <link href="https://blog.downager.com/2019/03/21/%E9%9A%A8%E7%AD%86-VMWare-ESXi-%E7%AD%86%E8%A8%98/"/>
    <id>https://blog.downager.com/2019/03/21/%E9%9A%A8%E7%AD%86-VMWare-ESXi-%E7%AD%86%E8%A8%98/</id>
    <published>2019-03-21T03:03:05.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ESXi-Command"><a href="#ESXi-Command" class="headerlink" title="ESXi Command"></a>ESXi Command</h2><ul><li><p><strong>Restart</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01:~] esxcli system maintenanceMode set -e true</span><br><span class="line">[root@node01:~] esxcli system shutdown reboot -d 10 -r &quot;WEB CRASH&quot;</span><br></pre></td></tr></table></figure></li><li><p><strong>Shutdown guest vm</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01:~] esxcli vm process list </span><br><span class="line">[root@node01:~] esxcli vm process kill --type&#x3D;soft --world-id&#x3D;70636</span><br></pre></td></tr></table></figure></li><li><p><strong>hostname</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli system hostname set --host&#x3D;esxi</span><br><span class="line">[root@esxi:~] esxcli system hostname set --domain&#x3D;fape.cloud</span><br><span class="line">[root@esxi:~] esxcli system hostname set --fqdn&#x3D;esxi.fape.cloud</span><br></pre></td></tr></table></figure><a id="more"></a></li><li><p><strong>Disk Clone</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi:~] cd &#x2F;vmfs&#x2F;volumes&#x2F;WD500G&#x2F;</span><br><span class="line">[root@esxi:&#x2F;vmfs&#x2F;volumes&#x2F;5b53a83f-dd90c63a-c2d4-0015176a9387] vmkfstools -i Ubuntu-Clean.vmdk -d thin &#x2F;vmfs&#x2F;volumes&#x2F;DSM_iSCSI_320GB&#x2F;SSR&#x2F;SSR.vmdk</span><br><span class="line">Destination disk format: VMFS thin-provisioned</span><br><span class="line">Cloning disk &#39;Ubuntu-Clean.vmdk&#39;...</span><br><span class="line">Clone: 100% done.</span><br><span class="line">[root@esxi:&#x2F;vmfs&#x2F;volumes&#x2F;5b53a83f-dd90c63a-c2d4-0015176a9387] exit</span><br></pre></td></tr></table></figure></li><li><p><strong>Enable SNMP</strong></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01:~] esxcli system snmp get</span><br><span class="line">[root@node01:~] esxcli system snmp set --help</span><br></pre></td></tr></table></figure></li><li><p><strong>Disk Passthrough</strong><br>  <a href="https://kb.vmware.com/s/article/1017530" target="_blank" rel="noopener">https://kb.vmware.com/s/article/1017530</a></p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node01:~] ls -l &#x2F;vmfs&#x2F;devices&#x2F;disks</span><br><span class="line">[root@node01:~] vmkfstools -z &#x2F;vmfs&#x2F;devices&#x2F;disks&#x2F;naa.5000c5002a06ade0 &#x2F;vmfs&#x2F;volumes&#x2F;datastore1&#x2F;FreeNAS&#x2F;320G_Disk1.vmdk</span><br><span class="line">[root@node01:~] vmkfstools -z &#x2F;vmfs&#x2F;devices&#x2F;disks&#x2F;naa.5000cca35bc41ad6 &#x2F;vmfs&#x2F;volumes&#x2F;datastore1&#x2F;FreeNAS&#x2F;320G_Disk2.vmdk</span><br><span class="line">[root@node01:~] vmkfstools -z &#x2F;vmfs&#x2F;devices&#x2F;disks&#x2F;naa.5000cca369d2fef5 &#x2F;vmfs&#x2F;volumes&#x2F;datastore1&#x2F;FreeNAS&#x2F;2TB_Disk1.vmdk</span><br><span class="line">[root@node01:~] vmkfstools -z &#x2F;vmfs&#x2F;devices&#x2F;disks&#x2F;naa.5000cca221dab4df &#x2F;vmfs&#x2F;volumes&#x2F;datastore1&#x2F;FreeNAS&#x2F;2TB_Disk2.vmdk</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ESXi-Command&quot;&gt;&lt;a href=&quot;#ESXi-Command&quot; class=&quot;headerlink&quot; title=&quot;ESXi Command&quot;&gt;&lt;/a&gt;ESXi Command&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Restart&lt;/strong&gt;&lt;/p&gt;
  &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@node01:~] esxcli system maintenanceMode set -e true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@node01:~] esxcli system shutdown reboot -d 10 -r &amp;quot;WEB CRASH&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Shutdown guest vm&lt;/strong&gt;&lt;/p&gt;
  &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@node01:~] esxcli vm process list &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@node01:~] esxcli vm process kill --type&amp;#x3D;soft --world-id&amp;#x3D;70636&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;hostname&lt;/strong&gt;&lt;/p&gt;
  &lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[root@localhost:~] esxcli system hostname set --host&amp;#x3D;esxi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@esxi:~] esxcli system hostname set --domain&amp;#x3D;fape.cloud&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[root@esxi:~] esxcli system hostname set --fqdn&amp;#x3D;esxi.fape.cloud&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Virtualization" scheme="https://blog.downager.com/categories/Virtualization/"/>
    
    
      <category term="虛擬化" scheme="https://blog.downager.com/tags/%E8%99%9B%E6%93%AC%E5%8C%96/"/>
    
      <category term="VMWare-ESXi" scheme="https://blog.downager.com/tags/VMWare-ESXi/"/>
    
  </entry>
  
  <entry>
    <title>[CentOS] zsh &amp; z.lua 快速選徑安裝</title>
    <link href="https://blog.downager.com/2019/03/07/CentOS-zsh-z-lua-%E5%BF%AB%E9%80%9F%E9%81%B8%E5%BE%91%E5%AE%89%E8%A3%9D/"/>
    <id>https://blog.downager.com/2019/03/07/CentOS-zsh-z-lua-%E5%BF%AB%E9%80%9F%E9%81%B8%E5%BE%91%E5%AE%89%E8%A3%9D/</id>
    <published>2019-03-07T13:21:33.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>菜鳥如我最近剛學了些提升命令行下生產力的工具，筆記一下安裝方法。</p><h1 id="安裝-zsh"><a href="#安裝-zsh" class="headerlink" title="安裝 zsh"></a>安裝 zsh</h1><h3 id="1-安裝-zsh-amp-git-包"><a href="#1-安裝-zsh-amp-git-包" class="headerlink" title="1. 安裝 zsh &amp; git 包"></a>1. 安裝 zsh &amp; git 包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install zsh git</span><br></pre></td></tr></table></figure><h3 id="2-將預設-shell-更換為-zsh"><a href="#2-將預設-shell-更換為-zsh" class="headerlink" title="2. 將預設 shell 更換為 zsh"></a>2. 將預設 shell 更換為 zsh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chsh -s &#x2F;bin&#x2F;zsh</span><br></pre></td></tr></table></figure><h3 id="3-登出帳號讓配置生效"><a href="#3-登出帳號讓配置生效" class="headerlink" title="3. 登出帳號讓配置生效"></a>3. 登出帳號讓配置生效</h3><h3 id="4-安裝-Oh-My-Zsh"><a href="#4-安裝-Oh-My-Zsh" class="headerlink" title="4. 安裝 Oh My Zsh"></a>4. 安裝 Oh My Zsh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;robbyrussell&#x2F;oh-my-zsh&#x2F;master&#x2F;tools&#x2F;install.sh)&quot;</span><br></pre></td></tr></table></figure><h3 id="5-可以根據需要自行調整主題"><a href="#5-可以根據需要自行調整主題" class="headerlink" title="5. 可以根據需要自行調整主題"></a>5. 可以根據需要自行調整主題</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim ~&#x2F;.zshrc</span><br><span class="line"></span><br><span class="line">ZSH_THEME&#x3D;&quot;robbyrussell&quot;</span><br></pre></td></tr></table></figure><a id="more"></a> <h1 id="安裝-z-lua"><a href="#安裝-z-lua" class="headerlink" title="安裝 z.lua"></a>安裝 z.lua</h1><h3 id="1-下載-z-lua"><a href="#1-下載-z-lua" class="headerlink" title="1. 下載 z.lua"></a>1. 下載 z.lua</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;etc</span><br><span class="line">sudo curl -O https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;skywind3000&#x2F;z.lua&#x2F;master&#x2F;z.lua</span><br></pre></td></tr></table></figure><h3 id="2-編輯-zshrc-啟用-z-lua"><a href="#2-編輯-zshrc-啟用-z-lua" class="headerlink" title="2. 編輯 .zshrc 啟用 z.lua"></a>2. 編輯 .zshrc 啟用 z.lua</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~&#x2F;.zshrc</span><br></pre></td></tr></table></figure><ul><li><strong>新增以下內容</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">eval &quot;$(lua &#x2F;etc&#x2F;z.lua  --init zsh enhanced once echo)&quot;  </span><br><span class="line"></span><br><span class="line">alias zc&#x3D;&#39;z -c&#39;      # 嚴格匹配當前路徑的子路徑</span><br><span class="line">alias zz&#x3D;&#39;z -i&#39;      # 使用交互式選擇模式</span><br><span class="line">alias zf&#x3D;&#39;z -I&#39;      # 使用 fzf 對多個結果進行選擇</span><br><span class="line">alias zb&#x3D;&#39;z -b&#39;      # 快速回到父目錄</span><br></pre></td></tr></table></figure><h3 id="3-重新登錄後即可生效"><a href="#3-重新登錄後即可生效" class="headerlink" title="3. 重新登錄後即可生效"></a>3. 重新登錄後即可生效</h3></li></ul><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/56077546" target="_blank" rel="noopener">一个会学习你习惯的 cd 命令 - z.lua</a></li><li><a href="https://www.zhihu.com/question/21418449" target="_blank" rel="noopener">为什么说 zsh 是 shell 中的极品？</a></li><li><a href="https://www.jianshu.com/p/556ff130fc65" target="_blank" rel="noopener">CentOs安装oh my zsh</a></li><li><a href="https://github.com/skywind3000/z.lua" target="_blank" rel="noopener">skywind3000/z.lua</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;菜鳥如我最近剛學了些提升命令行下生產力的工具，筆記一下安裝方法。&lt;/p&gt;
&lt;h1 id=&quot;安裝-zsh&quot;&gt;&lt;a href=&quot;#安裝-zsh&quot; class=&quot;headerlink&quot; title=&quot;安裝 zsh&quot;&gt;&lt;/a&gt;安裝 zsh&lt;/h1&gt;&lt;h3 id=&quot;1-安裝-zsh-amp-git-包&quot;&gt;&lt;a href=&quot;#1-安裝-zsh-amp-git-包&quot; class=&quot;headerlink&quot; title=&quot;1. 安裝 zsh &amp;amp; git 包&quot;&gt;&lt;/a&gt;1. 安裝 zsh &amp;amp; git 包&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install zsh git&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;2-將預設-shell-更換為-zsh&quot;&gt;&lt;a href=&quot;#2-將預設-shell-更換為-zsh&quot; class=&quot;headerlink&quot; title=&quot;2. 將預設 shell 更換為 zsh&quot;&gt;&lt;/a&gt;2. 將預設 shell 更換為 zsh&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;chsh -s &amp;#x2F;bin&amp;#x2F;zsh&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;3-登出帳號讓配置生效&quot;&gt;&lt;a href=&quot;#3-登出帳號讓配置生效&quot; class=&quot;headerlink&quot; title=&quot;3. 登出帳號讓配置生效&quot;&gt;&lt;/a&gt;3. 登出帳號讓配置生效&lt;/h3&gt;&lt;h3 id=&quot;4-安裝-Oh-My-Zsh&quot;&gt;&lt;a href=&quot;#4-安裝-Oh-My-Zsh&quot; class=&quot;headerlink&quot; title=&quot;4. 安裝 Oh My Zsh&quot;&gt;&lt;/a&gt;4. 安裝 Oh My Zsh&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sh -c &amp;quot;$(curl -fsSL https:&amp;#x2F;&amp;#x2F;raw.githubusercontent.com&amp;#x2F;robbyrussell&amp;#x2F;oh-my-zsh&amp;#x2F;master&amp;#x2F;tools&amp;#x2F;install.sh)&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h3 id=&quot;5-可以根據需要自行調整主題&quot;&gt;&lt;a href=&quot;#5-可以根據需要自行調整主題&quot; class=&quot;headerlink&quot; title=&quot;5. 可以根據需要自行調整主題&quot;&gt;&lt;/a&gt;5. 可以根據需要自行調整主題&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;vim ~&amp;#x2F;.zshrc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ZSH_THEME&amp;#x3D;&amp;quot;robbyrussell&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.downager.com/categories/Linux/"/>
    
    
      <category term="CentOS" scheme="https://blog.downager.com/tags/CentOS/"/>
    
      <category term="Shell" scheme="https://blog.downager.com/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>[Windows] Windows 10 2019 LTSC Eval（評估版）無痛轉換成 Full version（完整版）</title>
    <link href="https://blog.downager.com/2019/02/22/Windows-Win10-2019-LTSC-Eval%EF%BC%88%E8%A9%95%E4%BC%B0%E7%89%88%EF%BC%89%E7%84%A1%E7%97%9B%E8%BD%89%E6%8F%9B%E6%88%90-Full-version%EF%BC%88%E5%AE%8C%E6%95%B4%E7%89%88%EF%BC%89/"/>
    <id>https://blog.downager.com/2019/02/22/Windows-Win10-2019-LTSC-Eval%EF%BC%88%E8%A9%95%E4%BC%B0%E7%89%88%EF%BC%89%E7%84%A1%E7%97%9B%E8%BD%89%E6%8F%9B%E6%88%90-Full-version%EF%BC%88%E5%AE%8C%E6%95%B4%E7%89%88%EF%BC%89/</id>
    <published>2019-02-22T13:14:57.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近剛好要重灌電腦就順便裝了 LTSC 版本，本來想說不要亂下載非官方的 ISO 檔比較安全，特別去下載微軟官方評估版來安裝，結果 Eval 版本沒辦法用完整版序號來洗成正版，官方表明不能升級只能重裝，還好最後有找到免重裝的方法，重灌實在是太麻煩了…</p><h1 id="準備完整版-Windows-10-2019-LTSC-ISO"><a href="#準備完整版-Windows-10-2019-LTSC-ISO" class="headerlink" title="準備完整版 Windows 10 2019 LTSC ISO"></a>準備完整版 Windows 10 2019 LTSC ISO</h1><h4 id="1-下載-EN-US-Windows-10-2019-LTSC-Eval-ISO（微軟載點）"><a href="#1-下載-EN-US-Windows-10-2019-LTSC-Eval-ISO（微軟載點）" class="headerlink" title="1. 下載 EN-US Windows 10 2019 LTSC Eval ISO（微軟載點）"></a>1. 下載 EN-US Windows 10 2019 LTSC Eval ISO（微軟載點）</h4><ul><li><a href="https://software-download.microsoft.com/download/pr/17763.1.180914-1434.rs5_release_CLIENT_LTSC_EVAL_x64FRE_en-us.iso" target="_blank" rel="noopener">17763.1.180914-1434.rs5_release_CLIENT_LTSC_EVAL_x64FRE_en-us.iso</a></li><li><a href="https://software-download.microsoft.com/download/pr/17763.1.180914-1434.rs5_release_CLIENT_LTSC_EVAL_x86FRE_en-us.iso" target="_blank" rel="noopener">17763.1.180914-1434.rs5_release_CLIENT_LTSC_EVAL_x86FRE_en-us.iso</a></li></ul><h4 id="2-下載-SPF-檔案-Language-Patch"><a href="#2-下載-SPF-檔案-Language-Patch" class="headerlink" title="2.  下載 SPF 檔案 (Language Patch)"></a>2.  下載 SPF 檔案 (Language Patch)</h4><p><a href="https://multiup.org/project/27b404c4cdef0b7def4a9c7f0e303f3e" target="_blank" rel="noopener"><code>Password: MDL</code></a></p><a id="more"></a> <h4 id="3-利用-SVF-ISO-convertor-將檔案合併成完整版-ISO"><a href="#3-利用-SVF-ISO-convertor-將檔案合併成完整版-ISO" class="headerlink" title="3. 利用 SVF ISO convertor 將檔案合併成完整版 ISO"></a>3. 利用 SVF ISO convertor 將檔案合併成完整版 ISO</h4><ul><li>下載 <a href="https://www.softpedia.com/get/System/Back-Up-and-Recovery/SVF-eXtractor.shtml" target="_blank" rel="noopener">svfx.exe</a>，選取 ISO &amp; SVF 並驗證</li></ul><img src="/2019/02/22/Windows-Win10-2019-LTSC-Eval%EF%BC%88%E8%A9%95%E4%BC%B0%E7%89%88%EF%BC%89%E7%84%A1%E7%97%9B%E8%BD%89%E6%8F%9B%E6%88%90-Full-version%EF%BC%88%E5%AE%8C%E6%95%B4%E7%89%88%EF%BC%89/SVF.png" class=""><h1 id="修改-Register-騙過微軟升級檢測"><a href="#修改-Register-騙過微軟升級檢測" class="headerlink" title="修改 Register 騙過微軟升級檢測"></a>修改 Register 騙過微軟升級檢測</h1><p>路徑：<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion</code></p><ul><li><code>Composition edition ID</code>:  EnterpriseS</li><li><code>EditionID</code>: EnterpriseS</li><li><code>Product name</code>: Windows 10 Enterprise LTSC 2019</li></ul><h1 id="掛載-Full-version-ISO-進行升級"><a href="#掛載-Full-version-ISO-進行升級" class="headerlink" title="掛載 Full version ISO 進行升級"></a>掛載 Full version ISO 進行升級</h1><p><strong>修改完 Register 後不要重開機，直接掛載 ISO 進行升級並保留資料，記得要勾選下載更新，才不會有問題</strong></p><img src="/2019/02/22/Windows-Win10-2019-LTSC-Eval%EF%BC%88%E8%A9%95%E4%BC%B0%E7%89%88%EF%BC%89%E7%84%A1%E7%97%9B%E8%BD%89%E6%8F%9B%E6%88%90-Full-version%EF%BC%88%E5%AE%8C%E6%95%B4%E7%89%88%EF%BC%89/Win10_Installer.jpg" class=""><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://forums.mydigitallife.net/threads/windows-10-svf-repository.63324/page-128#post-1468363" target="_blank" rel="noopener">Windows 10 SVF Repository#2546 @Enthousiast</a></li><li><a href="https://gist.github.com/CHEF-KOCH/35a857cf4a08a837958fb71e252a84da" target="_blank" rel="noopener">CHEF-KOCH/How to use svf to upgrade your Windows.txt</a></li><li><a href="https://winaero.com/blog/upgrade-windows-10-evaluation-to-full-version-easily/" target="_blank" rel="noopener">Upgrade Windows 10 Evaluation to Full version easily</a></li><li><a href="https://www.reddit.com/r/Piracy/comments/a6zabz/windows_10_ltsc_evaluation_activation/" target="_blank" rel="noopener">Windows 10 LTSC Evaluation - Activation</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;最近剛好要重灌電腦就順便裝了 LTSC 版本，本來想說不要亂下載非官方的 ISO 檔比較安全，特別去下載微軟官方評估版來安裝，結果 Eval 版本沒辦法用完整版序號來洗成正版，官方表明不能升級只能重裝，還好最後有找到免重裝的方法，重灌實在是太麻煩了…&lt;/p&gt;
&lt;h1 id=&quot;準備完整版-Windows-10-2019-LTSC-ISO&quot;&gt;&lt;a href=&quot;#準備完整版-Windows-10-2019-LTSC-ISO&quot; class=&quot;headerlink&quot; title=&quot;準備完整版 Windows 10 2019 LTSC ISO&quot;&gt;&lt;/a&gt;準備完整版 Windows 10 2019 LTSC ISO&lt;/h1&gt;&lt;h4 id=&quot;1-下載-EN-US-Windows-10-2019-LTSC-Eval-ISO（微軟載點）&quot;&gt;&lt;a href=&quot;#1-下載-EN-US-Windows-10-2019-LTSC-Eval-ISO（微軟載點）&quot; class=&quot;headerlink&quot; title=&quot;1. 下載 EN-US Windows 10 2019 LTSC Eval ISO（微軟載點）&quot;&gt;&lt;/a&gt;1. 下載 EN-US Windows 10 2019 LTSC Eval ISO（微軟載點）&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://software-download.microsoft.com/download/pr/17763.1.180914-1434.rs5_release_CLIENT_LTSC_EVAL_x64FRE_en-us.iso&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;17763.1.180914-1434.rs5_release_CLIENT_LTSC_EVAL_x64FRE_en-us.iso&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://software-download.microsoft.com/download/pr/17763.1.180914-1434.rs5_release_CLIENT_LTSC_EVAL_x86FRE_en-us.iso&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;17763.1.180914-1434.rs5_release_CLIENT_LTSC_EVAL_x86FRE_en-us.iso&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;2-下載-SPF-檔案-Language-Patch&quot;&gt;&lt;a href=&quot;#2-下載-SPF-檔案-Language-Patch&quot; class=&quot;headerlink&quot; title=&quot;2.  下載 SPF 檔案 (Language Patch)&quot;&gt;&lt;/a&gt;2.  下載 SPF 檔案 (Language Patch)&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://multiup.org/project/27b404c4cdef0b7def4a9c7f0e303f3e&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Password: MDL&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Windows" scheme="https://blog.downager.com/categories/Windows/"/>
    
    
      <category term="Windows" scheme="https://blog.downager.com/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>[CentOS] CentOS 7 GitLab 安裝 &amp; HTTPS 設定</title>
    <link href="https://blog.downager.com/2019/01/31/CentOS-CentOS-7-GitLab-%E5%AE%89%E8%A3%9D-HTTPS-%E8%A8%AD%E5%AE%9A/"/>
    <id>https://blog.downager.com/2019/01/31/CentOS-CentOS-7-GitLab-%E5%AE%89%E8%A3%9D-HTTPS-%E8%A8%AD%E5%AE%9A/</id>
    <published>2019-01-31T06:30:03.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h2><h3 id="1-安裝基礎套件"><a href="#1-安裝基礎套件" class="headerlink" title="1. 安裝基礎套件"></a>1. 安裝基礎套件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 更新並安裝套件</span><br><span class="line">yum update</span><br><span class="line">yum install -y curl policycoreutils-python openssh-server openssh-clients</span><br><span class="line"># sshd 開機啟動</span><br><span class="line">systemctl enable sshd</span><br><span class="line">systemctl start sshd</span><br><span class="line"></span><br><span class="line"># 安裝 postfix</span><br><span class="line">yum install postfix</span><br><span class="line"># postfix 開機自動啟用</span><br><span class="line">systemctl enable postfix</span><br><span class="line">systemctl start postfix</span><br></pre></td></tr></table></figure><a id="more"></a> <h3 id="2-安裝-GitLab-CE"><a href="#2-安裝-GitLab-CE" class="headerlink" title="2. 安裝 GitLab-CE"></a>2. 安裝 GitLab-CE</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sS https:&#x2F;&#x2F;packages.gitlab.com&#x2F;install&#x2F;repositories&#x2F;gitlab&#x2F;gitlab-ce&#x2F;script.rpm.sh | sudo bash</span><br><span class="line">yum install -y gitlab-ce</span><br></pre></td></tr></table></figure><h3 id="3-拷貝-HTTPS-證書"><a href="#3-拷貝-HTTPS-證書" class="headerlink" title="3. 拷貝 HTTPS 證書"></a>3. 拷貝 HTTPS 證書</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;etc&#x2F;gitlab&#x2F;ssl</span><br><span class="line">chmod 700 &#x2F;etc&#x2F;gitlab&#x2F;ssl</span><br><span class="line">cp gitlab.example.com.key gitlab.example.com.crt &#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;</span><br></pre></td></tr></table></figure><h3 id="4-編輯-gitlab-rb"><a href="#4-編輯-gitlab-rb" class="headerlink" title="4. 編輯 gitlab.rb"></a>4. 編輯 gitlab.rb</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 修改配置文件</span><br><span class="line">vim &#x2F;etc&#x2F;gitlab&#x2F;gitlab.rb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改對外域名</span><br><span class="line">external_url &#39;https:&#x2F;&#x2F;gitlab.example.com&#39;</span><br><span class="line"># HTTPS 重導向</span><br><span class="line">nginx[&#39;redirect_http_to_https&#39;] &#x3D; true</span><br><span class="line">nginx[&#39;redirect_http_to_https_port&#39;] &#x3D; 80</span><br><span class="line"># 修改證書 &amp; 私鑰對應檔案位置</span><br><span class="line">nginx[&#39;ssl_certificate&#39;] &#x3D; &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.crt&quot;</span><br><span class="line">nginx[&#39;ssl_certificate_key&#39;] &#x3D; &quot;&#x2F;etc&#x2F;gitlab&#x2F;ssl&#x2F;gitlab.example.com.key&quot;</span><br><span class="line"></span><br><span class="line"># SMTP 設定依照需求自行參考此篇</span><br><span class="line">[SMTP settings](https:&#x2F;&#x2F;docs.gitlab.com&#x2F;omnibus&#x2F;settings&#x2F;smtp.html)</span><br><span class="line"></span><br><span class="line"># 重新加載配置文件</span><br><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><h3 id="5-防火牆放行-https-流量"><a href="#5-防火牆放行-https-流量" class="headerlink" title="5. 防火牆放行 https 流量"></a>5. 防火牆放行 https 流量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-service&#x3D;https</span><br><span class="line">systemctl reload firewalld</span><br></pre></td></tr></table></figure><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://about.gitlab.com/install/#centos-7?version=ce" target="_blank" rel="noopener">Omnibus package installation (recommended)</a></li><li><a href="https://docs.gitlab.com/omnibus/settings/smtp.html" target="_blank" rel="noopener">SMTP settings</a></li><li><a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/settings/nginx.md" target="_blank" rel="noopener">NGINX settings</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;安裝步驟&quot;&gt;&lt;a href=&quot;#安裝步驟&quot; class=&quot;headerlink&quot; title=&quot;安裝步驟&quot;&gt;&lt;/a&gt;安裝步驟&lt;/h2&gt;&lt;h3 id=&quot;1-安裝基礎套件&quot;&gt;&lt;a href=&quot;#1-安裝基礎套件&quot; class=&quot;headerlink&quot; title=&quot;1. 安裝基礎套件&quot;&gt;&lt;/a&gt;1. 安裝基礎套件&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# 更新並安裝套件&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install -y curl policycoreutils-python openssh-server openssh-clients&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# sshd 開機啟動&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl enable sshd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start sshd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 安裝 postfix&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum install postfix&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# postfix 開機自動啟用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl enable postfix&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;systemctl start postfix&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.downager.com/categories/Linux/"/>
    
    
      <category term="CentOS" scheme="https://blog.downager.com/tags/CentOS/"/>
    
      <category term="GitLab" scheme="https://blog.downager.com/tags/GitLab/"/>
    
  </entry>
  
  <entry>
    <title>[隨筆] Cisco 2960X IOS 版本挑選 &amp; 更新</title>
    <link href="https://blog.downager.com/2018/11/25/%E9%9A%A8%E7%AD%86-Cisco-2960X-IOS-%E7%89%88%E6%9C%AC%E6%8C%91%E9%81%B8-%E6%9B%B4%E6%96%B0/"/>
    <id>https://blog.downager.com/2018/11/25/%E9%9A%A8%E7%AD%86-Cisco-2960X-IOS-%E7%89%88%E6%9C%AC%E6%8C%91%E9%81%B8-%E6%9B%B4%E6%96%B0/</id>
    <published>2018-11-25T10:20:07.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<h2 id="版本挑選"><a href="#版本挑選" class="headerlink" title="版本挑選"></a>版本挑選</h2><h4 id="版本號說明請參考友站連結："><a href="#版本號說明請參考友站連結：" class="headerlink" title="版本號說明請參考友站連結："></a>版本號說明請參考友站連結：</h4><p><a href="http://bigpxuan.blogspot.com/2017/02/cisco12415.html" target="_blank" rel="noopener">大軒軒的筆記本 - Cisco版本號說明12.4和15</a></p><h4 id="官方工具："><a href="#官方工具：" class="headerlink" title="官方工具："></a>官方工具：</h4><ul><li><a href="https://software.cisco.com/download/home/" target="_blank" rel="noopener">Cisco Software Download</a><br>輸入 Product Name 來搜尋 &amp; 下載 IOS，沒有特別需求一般推薦選擇 Suggested Release</li><li><a href="https://tools.cisco.com/security/center/softwarechecker.x" target="_blank" rel="noopener">Cisco IOS Software Checker</a><br>檢查對應版本是否有已知漏洞</li><li><a href="https://bst.cloudapps.cisco.com/bugsearch/" target="_blank" rel="noopener">Cisco Bug Search Tool</a><br>輸入 Product Name &amp; Releases，查詢是否有已知的 Bug</li></ul><a id="more"></a> <h2 id="更新步驟"><a href="#更新步驟" class="headerlink" title="更新步驟"></a>更新步驟</h2><h4 id="1-設定-Layer-3-介面（int-vlan1-也可以），待會要利用-TFTP-來傳輸-Image"><a href="#1-設定-Layer-3-介面（int-vlan1-也可以），待會要利用-TFTP-來傳輸-Image" class="headerlink" title="1. 設定 Layer 3 介面（int vlan1 也可以），待會要利用 TFTP 來傳輸 Image"></a>1. 設定 Layer 3 介面（int vlan1 也可以），待會要利用 TFTP 來傳輸 Image</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Switch#conf t</span><br><span class="line"></span><br><span class="line">Switch(config)#int fastEthernet 0</span><br><span class="line">Switch(config-if)#ip address 192.168.1.33 255.255.255.0</span><br><span class="line">Switch(config-if)#no shutdown </span><br><span class="line">Switch(config-if)#</span><br></pre></td></tr></table></figure><h4 id="2-測通-TFTP-Server"><a href="#2-測通-TFTP-Server" class="headerlink" title="2. 測通 TFTP Server"></a>2. 測通 TFTP Server</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Switch#ping 192.168.1.100</span><br><span class="line">Type escape sequence to abort.</span><br><span class="line">Sending 5, 100-byte ICMP Echos to 192.168.1.100, timeout is 2 seconds:</span><br><span class="line">!!!!!</span><br><span class="line">Success rate is 100 percent (5&#x2F;5), round-trip min&#x2F;avg&#x2F;max &#x3D; 1&#x2F;203&#x2F;1000 ms</span><br><span class="line">Switch#</span><br></pre></td></tr></table></figure><h4 id="3-Copy-IOS-Image-到-flash-上"><a href="#3-Copy-IOS-Image-到-flash-上" class="headerlink" title="3. Copy IOS Image 到 flash 上"></a>3. Copy IOS Image 到 flash 上</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Switch#copy tftp flash:</span><br><span class="line">Address or name of remote host []? 192.168.1.100</span><br><span class="line">Source filename []? c2960x-universalk9-mz.152-2.E9.bin</span><br><span class="line">Destination filename [c2960x-universalk9-mz.152-2.E9.bin]? </span><br><span class="line">Accessing tftp:&#x2F;&#x2F;192.168.1.100&#x2F;c2960x-universalk9-mz.152-2.E9.bin...</span><br><span class="line">Loading c2960x-universalk9-mz.152-2.E9.bin from 192.168.1.100 (via FastEthernet0): !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><br><span class="line">[OK - 21141504 bytes]</span><br><span class="line"></span><br><span class="line">21141504 bytes copied in 171.882 secs (123000 bytes&#x2F;sec)</span><br><span class="line">Switch#</span><br></pre></td></tr></table></figure><h4 id="4-檢查檔案"><a href="#4-檢查檔案" class="headerlink" title="4. 檢查檔案"></a>4. 檢查檔案</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Switch#show flash:</span><br><span class="line"></span><br><span class="line">Directory of flash:&#x2F;</span><br><span class="line"></span><br><span class="line">  671  -rwx        1048  Nov 23 2018 02:34:38 +00:00  multiple-fs</span><br><span class="line">    2  -rwx          34  Nov 23 2018 02:38:12 +00:00  pnp-tech-time</span><br><span class="line">    3  -rwx       11117  Nov 23 2018 02:38:14 +00:00  pnp-tech-discovery-summary</span><br><span class="line">  672  -rwx    21141504  Nov 23 2018 02:53:15 +00:00  c2960x-universalk9-mz.152-2.E9.bin</span><br><span class="line">    4  drwx         512   Aug 8 2018 17:23:16 +00:00  c2960x-universalk9-mz.152-2.E7</span><br><span class="line">  669  drwx         512   Aug 8 2018 17:23:16 +00:00  dc_profile_dir</span><br><span class="line"></span><br><span class="line">122185728 bytes total (73718272 bytes free)</span><br><span class="line">Switch#</span><br></pre></td></tr></table></figure><h4 id="5-設定-boot-參數為新的-IOS-Image"><a href="#5-設定-boot-參數為新的-IOS-Image" class="headerlink" title="5. 設定 boot 參數為新的 IOS Image"></a>5. 設定 boot 參數為新的 IOS Image</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Switch#show boot</span><br><span class="line">BOOT path-list      : flash:&#x2F;c2960x-universalk9-mz.152-2.E7&#x2F;c2960x-universalk9-mz.152-2.E7.bin</span><br><span class="line">Config file         : flash:&#x2F;config.text</span><br><span class="line">Private Config file : flash:&#x2F;private-config.text</span><br><span class="line">Enable Break        : yes</span><br><span class="line">Manual Boot         : no</span><br><span class="line">Allow Dev Key         : yes</span><br><span class="line">HELPER path-list    : </span><br><span class="line">Auto upgrade        : yes</span><br><span class="line">Auto upgrade path   : </span><br><span class="line">NVRAM&#x2F;Config file</span><br><span class="line">      buffer size:   524288</span><br><span class="line">Timeout for Config</span><br><span class="line">          Download:    0 seconds</span><br><span class="line">Config Download </span><br><span class="line">       via DHCP:       disabled (next boot: disabled)</span><br><span class="line">Switch#</span><br><span class="line"></span><br><span class="line">Switch#conf t</span><br><span class="line">Switch(config)#boot system flash:c2960x-universalk9-mz.152-2.E9.bin</span><br><span class="line"></span><br><span class="line">Switch(config)#end</span><br><span class="line">Switch#show boot</span><br><span class="line">BOOT path-list      : flash:c2960x-universalk9-mz.152-2.E9.bin</span><br><span class="line">Config file         : flash:&#x2F;config.text</span><br><span class="line">Private Config file : flash:&#x2F;private-config.text</span><br><span class="line">Enable Break        : yes</span><br><span class="line">Manual Boot         : no</span><br><span class="line">Allow Dev Key         : yes</span><br><span class="line">HELPER path-list    : </span><br><span class="line">Auto upgrade        : yes</span><br><span class="line">Auto upgrade path   : </span><br><span class="line">NVRAM&#x2F;Config file</span><br><span class="line">      buffer size:   524288</span><br><span class="line">Timeout for Config</span><br><span class="line">          Download:    0 seconds</span><br><span class="line">Config Download </span><br><span class="line">       via DHCP:       disabled (next boot: disabled)</span><br><span class="line">Switch#</span><br></pre></td></tr></table></figure><h4 id="6-存檔-amp-reload"><a href="#6-存檔-amp-reload" class="headerlink" title="6. 存檔 &amp; reload"></a>6. 存檔 &amp; reload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Switch#write </span><br><span class="line">Building configuration...</span><br><span class="line">[OK]</span><br><span class="line">Switch#reload</span><br><span class="line">Proceed with reload? [confirm]</span><br><span class="line"></span><br><span class="line">Nov 23 03:05:08.769: %SYS-5-RELOAD: Reload requested by console. Reload Reason: Reload command.</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;版本挑選&quot;&gt;&lt;a href=&quot;#版本挑選&quot; class=&quot;headerlink&quot; title=&quot;版本挑選&quot;&gt;&lt;/a&gt;版本挑選&lt;/h2&gt;&lt;h4 id=&quot;版本號說明請參考友站連結：&quot;&gt;&lt;a href=&quot;#版本號說明請參考友站連結：&quot; class=&quot;headerlink&quot; title=&quot;版本號說明請參考友站連結：&quot;&gt;&lt;/a&gt;版本號說明請參考友站連結：&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;http://bigpxuan.blogspot.com/2017/02/cisco12415.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;大軒軒的筆記本 - Cisco版本號說明12.4和15&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&quot;官方工具：&quot;&gt;&lt;a href=&quot;#官方工具：&quot; class=&quot;headerlink&quot; title=&quot;官方工具：&quot;&gt;&lt;/a&gt;官方工具：&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://software.cisco.com/download/home/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Cisco Software Download&lt;/a&gt;&lt;br&gt;輸入 Product Name 來搜尋 &amp;amp; 下載 IOS，沒有特別需求一般推薦選擇 Suggested Release&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://tools.cisco.com/security/center/softwarechecker.x&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Cisco IOS Software Checker&lt;/a&gt;&lt;br&gt;檢查對應版本是否有已知漏洞&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://bst.cloudapps.cisco.com/bugsearch/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Cisco Bug Search Tool&lt;/a&gt;&lt;br&gt;輸入 Product Name &amp;amp; Releases，查詢是否有已知的 Bug&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Networking" scheme="https://blog.downager.com/categories/Networking/"/>
    
    
      <category term="隨筆" scheme="https://blog.downager.com/tags/%E9%9A%A8%E7%AD%86/"/>
    
      <category term="Cisco" scheme="https://blog.downager.com/tags/Cisco/"/>
    
  </entry>
  
  <entry>
    <title>[隨筆] Aruba Controller &amp; Palo Alto User-ID 整合筆記</title>
    <link href="https://blog.downager.com/2018/10/08/%E9%9A%A8%E7%AD%86-Aruba-Controller-Palo-Alto-User-ID-%E6%95%B4%E5%90%88%E7%AD%86%E8%A8%98/"/>
    <id>https://blog.downager.com/2018/10/08/%E9%9A%A8%E7%AD%86-Aruba-Controller-Palo-Alto-User-ID-%E6%95%B4%E5%90%88%E7%AD%86%E8%A8%98/</id>
    <published>2018-10-08T14:41:14.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<img src="/2018/10/08/%E9%9A%A8%E7%AD%86-Aruba-Controller-Palo-Alto-User-ID-%E6%95%B4%E5%90%88%E7%AD%86%E8%A8%98/User-ID.png" class=""><h1 id="Pre-configurations-on-the-Palo-Alto-Networks-Firewall"><a href="#Pre-configurations-on-the-Palo-Alto-Networks-Firewall" class="headerlink" title="Pre-configurations on the Palo Alto Networks Firewall"></a>Pre-configurations on the Palo Alto Networks Firewall</h1><h3 id="1-Create-New-Device-Admin-Account-For-Aruba"><a href="#1-Create-New-Device-Admin-Account-For-Aruba" class="headerlink" title="1. Create New Device Admin Account (For Aruba)"></a>1. Create New Device Admin Account (For Aruba)</h3><blockquote><p>An <strong>Device Admin</strong> account must be created on the Palo Alto Networks firewall to allow the controller to send data to it.<br>The built-in Admin account can be used for this purpose but that is not recommended.<br>It is better to create a new Admin account used solely for the purpose of communications between the controller and Palo Alto</p></blockquote><a id="more"></a> <h1 id="Aruba-Controller-Configuration-on-AOS-6-4"><a href="#Aruba-Controller-Configuration-on-AOS-6-4" class="headerlink" title="Aruba Controller Configuration on AOS 6.4"></a>Aruba Controller Configuration on AOS 6.4</h1><h3 id="1-Creating-the-Server-Profile-for-Palo-Alto-Network-on-the-Controller"><a href="#1-Creating-the-Server-Profile-for-Palo-Alto-Network-on-the-Controller" class="headerlink" title="1. Creating the Server Profile for Palo Alto Network on the Controller"></a>1. Creating the Server Profile for Palo Alto Network on the Controller</h3><blockquote><p><strong>To configure a new Palo Alto Networks profile</strong></p><ol><li>Navigate to Configuration &gt; Advanced Services &gt; All Profiles &gt; Other Profiles &gt; Palo Alto Networks Servers</li><li>Type the name of the profile and click Add</li><li>Click on the name of the profile created to open the Profile Details window</li><li>Enter the Host (IP address or hostname) of the Palo Alto Networks firewall</li><li>Enter the Port (1 – 65535) of the Palo Alto Networks Firewall<br>Note: The port used by default is 443</li><li>Enter the Username of the Palo Alto Networks firewall.<br>The user name is between 1 and 255 bytes in length and must match the Admin Account previously created on the Palo Alto Networks firewall.<br>Note: Refer to section 3.3</li><li>Enter the Password of the username in Palo Alto Networks Firewall. The password is between 6 and 100 bytes in length and must match the password of the Admin account previously created on the Palo Alto Networks firewall.</li><li>Re-enter the Password entered in the previous step</li><li>Click Add</li><li>Click Apply</li></ol></blockquote><h3 id="2-Activating-the-Palo-Alto-Networks-profile"><a href="#2-Activating-the-Palo-Alto-Networks-profile" class="headerlink" title="2. Activating the Palo Alto Networks profile"></a>2. Activating the Palo Alto Networks profile</h3><blockquote><p><strong>To apply a Palo Alto Networks Server profile on the local controller, complete the following steps:</strong></p><ol><li>Navigate to Configuration &gt; Advanced Services &gt; All Profiles &gt; Other Profiles &gt; Palo Alto Networks Active.</li><li>Select Active Palo Alto Networks. To the right of this link, the name of the active profile is displayed.</li><li>Other configured profile can be selected from the Active Palo Alto Networks Profile &gt; drop-down menu.<br>To configure a new profile, select NEW from the drop down menu and complete the configuration details.</li><li>Once a profile is selected from the drop-down menu or a new profile is created, click Apply. </li></ol></blockquote><h3 id="3-Enabling-the-Palo-Alto-Networks-Firewall-Integration"><a href="#3-Enabling-the-Palo-Alto-Networks-Firewall-Integration" class="headerlink" title="3. Enabling the Palo Alto Networks Firewall Integration"></a>3. Enabling the Palo Alto Networks Firewall Integration</h3><blockquote><p><strong>To enable a Palo Alto Netwokrs firewall integration in the AAA profile:</strong></p><ol><li>Navigate to Configuration &gt; Security &gt; Authentication &gt; AAA Profiles page</li><li>In the AAA Profiles Summary, select the desired profile</li><li>Check the PAN firewalls Integration check box</li><li>Click Apply</li></ol></blockquote><h1 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h1><h3 id="Q1-Timeout-Ping-不通"><a href="#Q1-Timeout-Ping-不通" class="headerlink" title="Q1. Timeout / Ping 不通"></a>Q1. Timeout / Ping 不通</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(Aruba7210) #ping &lt;pa_ip_addr&gt;</span><br><span class="line"></span><br><span class="line">Press &#39;q&#39; to abort.</span><br><span class="line">Sending 5, 92-byte ICMP Echos to &lt;pa_ip_addr&gt;, timeout is 2 seconds:</span><br><span class="line">.....</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(Aruba7210) #show pan state </span><br><span class="line"></span><br><span class="line">Palo Alto Networks Servers Connection State[PA5220]</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Firewall          State</span><br><span class="line">--------          -----</span><br><span class="line">&lt;pa_ip_addr&gt;:443  DOWN[10&#x2F;08&#x2F;18 14:29:42]</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(Aruba7210) # show log system all | include |pan|</span><br><span class="line"></span><br><span class="line">Oct 8 14:39:27 :309109:  &lt;WARN&gt; |extifmgr| |pan| Session to PAN server [https:&#x2F;&#x2F;&lt;pa_ip_addr&gt;:443&#x2F;api&#x2F;] Failed - code:1004[Timeout was reached(28)]</span><br></pre></td></tr></table></figure><h4 id="檢查-PA-是否放行-Controller-IP-訪問管理介面"><a href="#檢查-PA-是否放行-Controller-IP-訪問管理介面" class="headerlink" title="檢查 PA 是否放行 Controller IP 訪問管理介面"></a>檢查 PA 是否放行 Controller IP 訪問管理介面</h4><blockquote><p>Device &gt; Setup &gt; Interfaces &gt; Management &gt; Add Permitted IP Addresses</p></blockquote><h3 id="Q2-憑證問題"><a href="#Q2-憑證問題" class="headerlink" title="Q2. 憑證問題"></a>Q2. 憑證問題</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(Aruba7210) # show log system all | include |pan|</span><br><span class="line"></span><br><span class="line">Oct 8 15:19:20 :309109:  &lt;WARN&gt; |extifmgr| |pan| Session to PAN server [https:&#x2F;&#x2F;&lt;pa_ip_addr&gt;:443&#x2F;api&#x2F;] Failed - code:1003[Peer certificate cannot be authenticated with given CA certificates(60)]</span><br></pre></td></tr></table></figure><h4 id="從-PA-上匯出憑證至-Aruba-Controller"><a href="#從-PA-上匯出憑證至-Aruba-Controller" class="headerlink" title="從 PA 上匯出憑證至 Aruba Controller"></a>從 PA 上匯出憑證至 Aruba Controller</h4><blockquote><p><strong>Palo Alto:</strong><br>Device &gt; Certificate Management &gt; Certificate &gt; Export Certificate</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Export Certificate</span><br><span class="line">File Format: Base64 Encoded Certificate (PEM)</span><br></pre></td></tr></table></figure><blockquote><p><strong>Aruba Controller:</strong><br>Configuration &gt; Management &gt; Certificates &gt; Upload</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Upload a Certificate</span><br><span class="line">Certificate Format: PEM</span><br><span class="line">Certificate Type: Trusted CA</span><br></pre></td></tr></table></figure><p><strong>信任 CA 後依然顯示憑證有問題，嘗試以下做法</strong></p><blockquote><p><strong>Palo Alto 重新產生自簽證書</strong><br><strong><a href="https://www.paloaltonetworks.com/documentation/71/pan-os/pan-os/certificate-management/create-a-self-signed-root-ca-certificate" target="_blank" rel="noopener">Generate a Self-signed Root CA Certificate</a></strong></p><ol><li>Select Device &gt; Certificate Management &gt; Certificates &gt; Device Certificates.</li><li>If the firewall has more than one virtual system (vsys), select a Location (vsys or Shared) for the certificate.</li><li>Click Generate.</li><li>Enter a Certificate Name, such as GlobalProtect_CA. The name is case-sensitive and can have up to 31 characters. It must be unique and use only letters, numbers, hyphens, and underscores.</li><li>In the Common Name field, enter the FQDN (recommended) or IP address of the interface where you will configure the service that will use this certificate.</li><li>If the firewall has more than one vsys and you want the certificate to be available to every vsys, select the Shared check box.</li><li>Leave the Signed By field blank to designate the certificate as self-signed.</li><li>(Required) Select the Certificate Authority check box.</li><li>Leave the OCSP Responder field blank; revocation status verification doesn’t apply to root CA certificates.</li><li>Click Generate and Commit.</li></ol></blockquote><blockquote><p><strong>Palo Alto 證書替換管理流量證書（HTTPS）</strong><br><strong><a href="https://www.paloaltonetworks.com/documentation/71/pan-os/pan-os/certificate-management/replace-the-certificate-for-inbound-management-traffic" target="_blank" rel="noopener">Replace the Certificate for Inbound Management Traffic</a></strong></p><ol><li>Configure an SSL/TLS Service Profile.</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Select Device &gt; Certificate Management &gt; SSL&#x2F;TLS Service Profile &gt; </span><br><span class="line">Add &gt; Select the Certificate you just obtained</span><br><span class="line">Protocol Min Version: TLSv1.1</span><br></pre></td></tr></table></figure><blockquote><ol start="2"><li>Apply the SSL/TLS Service Profile to inbound management traffic.</li></ol></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Select Device &gt; Setup &gt; Management and edit the General Settings.</span><br><span class="line">Select the SSL&#x2F;TLS Service Profile you just configured.</span><br><span class="line">Click OK and Commit.</span><br></pre></td></tr></table></figure><h4 id="重新匯出剛剛新產生的憑證至-Aruba-Controller-並測試"><a href="#重新匯出剛剛新產生的憑證至-Aruba-Controller-並測試" class="headerlink" title="重新匯出剛剛新產生的憑證至 Aruba Controller 並測試"></a>重新匯出剛剛新產生的憑證至 Aruba Controller 並測試</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(Aruba7210) #show pan state </span><br><span class="line"></span><br><span class="line">Palo Alto Networks Servers Connection State[PA5220]</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Firewall          State</span><br><span class="line">--------          -----</span><br><span class="line">&lt;pa_ip_addr&gt;:443  UP[10&#x2F;08&#x2F;18 16:42:21]Established</span><br></pre></td></tr></table></figure><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://www.arubanetworks.com/pdf/partners/SG_PaloAltoNetworks.pdf" target="_blank" rel="noopener">Palo Alto Networks NextGeneration Firewall and Aruba WLAN Integration</a></li><li><a href="https://community.arubanetworks.com/t5/Wireless-Access/Troubleshoot-PAN-Integration/td-p/256433" target="_blank" rel="noopener">Troubleshoot PAN Integration</a></li><li><a href="https://www.paloaltonetworks.com/documentation/71/pan-os/pan-os/certificate-management/create-a-self-signed-root-ca-certificate" target="_blank" rel="noopener">Generate a Self-signed Root CA Certificate</a></li><li><a href="https://www.paloaltonetworks.com/documentation/71/pan-os/pan-os/certificate-management/replace-the-certificate-for-inbound-management-traffic" target="_blank" rel="noopener">Replace the Certificate for Inbound Management Traffic</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;img src=&quot;/2018/10/08/%E9%9A%A8%E7%AD%86-Aruba-Controller-Palo-Alto-User-ID-%E6%95%B4%E5%90%88%E7%AD%86%E8%A8%98/User-ID.png&quot; class=&quot;&quot;&gt;

&lt;h1 id=&quot;Pre-configurations-on-the-Palo-Alto-Networks-Firewall&quot;&gt;&lt;a href=&quot;#Pre-configurations-on-the-Palo-Alto-Networks-Firewall&quot; class=&quot;headerlink&quot; title=&quot;Pre-configurations on the Palo Alto Networks Firewall&quot;&gt;&lt;/a&gt;Pre-configurations on the Palo Alto Networks Firewall&lt;/h1&gt;&lt;h3 id=&quot;1-Create-New-Device-Admin-Account-For-Aruba&quot;&gt;&lt;a href=&quot;#1-Create-New-Device-Admin-Account-For-Aruba&quot; class=&quot;headerlink&quot; title=&quot;1. Create New Device Admin Account (For Aruba)&quot;&gt;&lt;/a&gt;1. Create New Device Admin Account (For Aruba)&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;An &lt;strong&gt;Device Admin&lt;/strong&gt; account must be created on the Palo Alto Networks firewall to allow the controller to send data to it.&lt;br&gt;The built-in Admin account can be used for this purpose but that is not recommended.&lt;br&gt;It is better to create a new Admin account used solely for the purpose of communications between the controller and Palo Alto&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Networking" scheme="https://blog.downager.com/categories/Networking/"/>
    
    
      <category term="隨筆" scheme="https://blog.downager.com/tags/%E9%9A%A8%E7%AD%86/"/>
    
      <category term="Aruba" scheme="https://blog.downager.com/tags/Aruba/"/>
    
      <category term="Palo-Alto" scheme="https://blog.downager.com/tags/Palo-Alto/"/>
    
  </entry>
  
  <entry>
    <title>[Ubuntu] OpenVAS 9 安裝</title>
    <link href="https://blog.downager.com/2018/08/05/Ubuntu-OpenVAS-9-%E5%AE%89%E8%A3%9D/"/>
    <id>https://blog.downager.com/2018/08/05/Ubuntu-OpenVAS-9-%E5%AE%89%E8%A3%9D/</id>
    <published>2018-08-05T00:04:52.000Z</published>
    <updated>2020-11-19T05:50:50.471Z</updated>
    
    <content type="html"><![CDATA[<h2 id="版本-Ubuntu-16-04-LTS"><a href="#版本-Ubuntu-16-04-LTS" class="headerlink" title="版本 Ubuntu 16.04 LTS"></a>版本 Ubuntu 16.04 LTS</h2><h3 id="加入-PPA-repository"><a href="#加入-PPA-repository" class="headerlink" title="加入 PPA repository"></a>加入 PPA repository</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-apt-repository ppa:mrazavi&#x2F;openvas</span><br></pre></td></tr></table></figure><h3 id="apt-update-及安裝套件"><a href="#apt-update-及安裝套件" class="headerlink" title="apt update 及安裝套件"></a>apt update 及安裝套件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install sqlite3</span><br><span class="line">apt install openvas9</span><br><span class="line">apt install libopenvas9-dev</span><br><span class="line">apt install smbclient</span><br></pre></td></tr></table></figure><a id="more"></a> <h3 id="同步-NVT-Feed-SCAP-Database-CERT-Database"><a href="#同步-NVT-Feed-SCAP-Database-CERT-Database" class="headerlink" title="同步 NVT Feed / SCAP Database / CERT Database"></a>同步 NVT Feed / SCAP Database / CERT Database</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">greenbone-nvt-sync</span><br><span class="line">greenbone-scapdata-sync</span><br><span class="line">greenbone-certdata-sync</span><br></pre></td></tr></table></figure><h3 id="重啟服務並加載-Feed"><a href="#重啟服務並加載-Feed" class="headerlink" title="重啟服務並加載 Feed"></a>重啟服務並加載 Feed</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service openvas-manager restart</span><br><span class="line">service openvas-scanner restart</span><br><span class="line">openvasmd --rebuild --progress</span><br></pre></td></tr></table></figure><h3 id="打開瀏覽器查看是否運作正常"><a href="#打開瀏覽器查看是否運作正常" class="headerlink" title="打開瀏覽器查看是否運作正常"></a>打開瀏覽器查看是否運作正常</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;&lt;your-ip-addr&gt;:4000</span><br><span class="line"></span><br><span class="line">預設帳號密碼 admin &#x2F; admin</span><br></pre></td></tr></table></figure><img src="/2018/08/05/Ubuntu-OpenVAS-9-%E5%AE%89%E8%A3%9D/OpenVAS_Web.jpg" class=""><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul><li><a href="https://hackertarget.com/openvas-9-install-ubuntu-1604/" target="_blank" rel="noopener">OpenVAS 9 install on Ubuntu 16.04</a></li><li><a href="http://www.netadmin.com.tw/article_content.aspx?sn=1606210002&jump=2" target="_blank" rel="noopener">自建OpenVAS弱點掃描 資安稽核報表不求人(下)</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;版本-Ubuntu-16-04-LTS&quot;&gt;&lt;a href=&quot;#版本-Ubuntu-16-04-LTS&quot; class=&quot;headerlink&quot; title=&quot;版本 Ubuntu 16.04 LTS&quot;&gt;&lt;/a&gt;版本 Ubuntu 16.04 LTS&lt;/h2&gt;&lt;h3 id=&quot;加入-PPA-repository&quot;&gt;&lt;a href=&quot;#加入-PPA-repository&quot; class=&quot;headerlink&quot; title=&quot;加入 PPA repository&quot;&gt;&lt;/a&gt;加入 PPA repository&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;add-apt-repository ppa:mrazavi&amp;#x2F;openvas&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;apt-update-及安裝套件&quot;&gt;&lt;a href=&quot;#apt-update-及安裝套件&quot; class=&quot;headerlink&quot; title=&quot;apt update 及安裝套件&quot;&gt;&lt;/a&gt;apt update 及安裝套件&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;apt update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apt install sqlite3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apt install openvas9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apt install libopenvas9-dev&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apt install smbclient&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://blog.downager.com/categories/Linux/"/>
    
    
      <category term="Ubuntu" scheme="https://blog.downager.com/tags/Ubuntu/"/>
    
      <category term="弱點掃描" scheme="https://blog.downager.com/tags/%E5%BC%B1%E9%BB%9E%E6%8E%83%E6%8F%8F/"/>
    
  </entry>
  
  <entry>
    <title>[隨筆] QNAP 原廠技術講習筆記</title>
    <link href="https://blog.downager.com/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/"/>
    <id>https://blog.downager.com/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/</id>
    <published>2018-06-12T14:43:12.000Z</published>
    <updated>2020-11-19T05:50:50.467Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Qtier-自動分層儲存-（Auto-Tiering）"><a href="#Qtier-自動分層儲存-（Auto-Tiering）" class="headerlink" title="Qtier 自動分層儲存 （Auto Tiering）"></a>Qtier 自動分層儲存 （Auto Tiering）</h2><blockquote><p>Qtier 技術實現自動分層儲存解決方案，可辨別資料存取頻率，自動將頻繁存取的「熱」資料移動到效能較高的磁碟階層，而將較少存取的「冷」資料移動到成本低、大容量的磁碟階層，讓企業享有效能與成本 （TCO） 兼顧的儲存服務。</p></blockquote><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/QNAP_001.png" class=""><a id="more"></a> <ul><li>所有資料會先寫入 SSD，之後再根據設定 （排程或是閒置時） 依照資料常用程度搬去低速裝置或搬來高速裝置</li></ul><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/QNAP_002.png" class=""><h2 id="磁碟區類型"><a href="#磁碟區類型" class="headerlink" title="磁碟區類型"></a>磁碟區類型</h2><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/QNAP_003.png" class=""><h3 id="單一靜態配置磁碟區（效能最佳）"><a href="#單一靜態配置磁碟區（效能最佳）" class="headerlink" title="單一靜態配置磁碟區（效能最佳）"></a>單一靜態配置磁碟區（效能最佳）</h3><blockquote><ul><li>靜態磁區使用所有於儲存池可用之空間，沒有快照、彈性調整容量的功能</li><li>組建完 Raid 後直接在上層建立檔案系統，效能會比多重完整配置來的好一些 （約 5% ~ 10%）<img src="/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/QNAP_004.jpg" class=""></li></ul></blockquote><h3 id="多重完整配置磁碟區（效能良好和較具彈性）"><a href="#多重完整配置磁碟區（效能良好和較具彈性）" class="headerlink" title="多重完整配置磁碟區（效能良好和較具彈性）"></a>多重完整配置磁碟區（效能良好和較具彈性）</h3><blockquote><ul><li>多重完整配置同時具有彈性及效能，可以靜態配置多個磁碟區，而非動態配置（彈性成長）<img src="/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/QNAP_005.jpg" class=""></li></ul></blockquote><ul><li>快照保留空間<ul><li>建立磁區時可設定保留快照空間而不會被佔用</li><li>不需要預先設定保留一樣可以使用快照 （所有<strong>未分配空間</strong>都能拿來放快照，若被分配完畢則無法使用）</li></ul></li><li>系統磁區 <strong>DataVol1</strong><ul><li>建議設定 40GB 獨立分割給系統專用 （不要放任何資料在這邊）</li><li>家目錄預設在 Vol.1，建議先關閉家目錄後再重新在其他 Volume 建立家目錄</li></ul></li></ul><h3 id="多重精簡配置磁碟區（彈性極佳和儲存使用效率較佳）"><a href="#多重精簡配置磁碟區（彈性極佳和儲存使用效率較佳）" class="headerlink" title="多重精簡配置磁碟區（彈性極佳和儲存使用效率較佳）"></a>多重精簡配置磁碟區（彈性極佳和儲存使用效率較佳）</h3><blockquote><ul><li>精簡配置對於儲存空間規劃提供了較佳的彈性。在磁碟區創建時並不會立即預備好實體的空間給予存取，而是在實際寫入時才會開始配置空間。</li><li>當你配置多個磁碟區時，初始為磁區設定上限值，當你寫入資料時才會動態配置磁區大小，因此若是有多個磁蝶區配置在上面，則會因為檔案不連續而影響效能。<img src="/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/QNAP_006.jpg" class=""></li></ul></blockquote><h2 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h2><blockquote><p>首先，快照並非備份，只是將當前的檔案狀態保存，日後有異動或是被加密可以回復到拍攝快照時的狀態。</p></blockquote><h3 id="QNAP-快照空間"><a href="#QNAP-快照空間" class="headerlink" title="QNAP 快照空間"></a>QNAP 快照空間</h3><ol><li>拍攝第一份快照，才會開始使用快照空間，此時使用大小約 3 MB ~ 5 MB</li><li>當你新增 500MB 的資料時，快照使用大小會變成 503 MB （此時尚未拍攝第二份快照）</li><li>拍攝第二份快照，此時使用大小變成 506 MB</li><li>移除剛剛新增的 500 MB 資料，快照使用大小依然不變</li><li>拍攝第三份快照，快照使用大小變成 509MB</li></ol><blockquote><p>根據以上結果簡單的得出一個結論</p><ul><li>快照和目錄的概念類似，上面記錄著拍攝當下時的檔案版本</li><li>快照使用空間跟檔案的新增和異動相關，只要你的檔案和第一份快照所記錄的不同，就會複製一份進快照空間，而做快照的動作只是建立版本號碼，可以讓你選擇回到哪個時間點的狀態</li></ul></blockquote><ul><li>根據以上特性，快照很適合用來防範勒索病毒，當資料被加密時就會即時的將被異動的檔案放入快照空間，就算被加密了，只要回到尚未加密的快照時間點即可。</li><li>快照本身沒有相依性，快照只是個目錄，所以單獨刪除中間的快照還是可以回到更早以前的版本</li></ul><h2 id="共用資料夾"><a href="#共用資料夾" class="headerlink" title="共用資料夾"></a>共用資料夾</h2><h3 id="權限大小"><a href="#權限大小" class="headerlink" title="權限大小"></a>權限大小</h3><p>權限大小按照順序來排列是 <strong>Deny &gt; Read/Write  &gt; Read-only</strong></p><blockquote><p>舉例來說：<br>假設你今天建立了一個 <code>MIS</code> 使用者群組，底下有 <code>Tom</code>、<code>Vincent</code> 兩位使用者<br>然後 <code>A</code> 資料夾 <code>MIS</code> 群組權限 <strong>R/W</strong>，<code>Tom</code> 使用者權限 <strong>Deny</strong><br>那結果就會是 <code>Tom</code> 無法存取，<code>MIS</code> 其他人一樣可讀可寫</p></blockquote><blockquote><p>例子二：<br><code>A</code> 資料夾 <code>MIS</code> 群組權限 <strong>R/W</strong>，<code>Vincent</code> 使用者權限 <strong>Read-only</strong><br>那 <code>Vincent</code> 使用者對於 <code>A</code> 資料夾的權限還是<strong>可讀可寫</strong>，因為 <strong>Read/Write  &gt; Read-only</strong><br>所以 <strong>Read/Write</strong> 就會覆蓋掉 <strong>Read-only</strong></p></blockquote><h3 id="Windows-ACL"><a href="#Windows-ACL" class="headerlink" title="Windows ACL"></a>Windows ACL</h3><blockquote><p>首先，微軟的資料夾權限有分為 <strong>共用權限</strong> 以及 <strong>安全性權限</strong> 兩種<br>而 QNAP 所提供 <strong>Windows ACL</strong> 功能則是將 <strong>安全性權限</strong> 放給 Windows 做管理</p></blockquote><ul><li>共用權限由 NAS 決定 （共用資料夾根目錄）</li><li>安全性權限由 Windows 決定 （子資料夾權限由 Windows 決定）</li></ul><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/QNAP_007.png" class=""><h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>以上資訊來自 QNAP 原廠工程師技術講習以及官方網站，若有理解錯誤請不吝告知，謝謝！</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Qtier-自動分層儲存-（Auto-Tiering）&quot;&gt;&lt;a href=&quot;#Qtier-自動分層儲存-（Auto-Tiering）&quot; class=&quot;headerlink&quot; title=&quot;Qtier 自動分層儲存 （Auto Tiering）&quot;&gt;&lt;/a&gt;Qtier 自動分層儲存 （Auto Tiering）&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Qtier 技術實現自動分層儲存解決方案，可辨別資料存取頻率，自動將頻繁存取的「熱」資料移動到效能較高的磁碟階層，而將較少存取的「冷」資料移動到成本低、大容量的磁碟階層，讓企業享有效能與成本 （TCO） 兼顧的儲存服務。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;img src=&quot;/2018/06/12/%E9%9A%A8%E7%AD%86-QNAP-%E5%8E%9F%E5%BB%A0%E6%8A%80%E8%A1%93%E8%AC%9B%E7%BF%92%E7%AD%86%E8%A8%98/QNAP_001.png&quot; class=&quot;&quot;&gt;
    
    </summary>
    
    
      <category term="Storage" scheme="https://blog.downager.com/categories/Storage/"/>
    
    
      <category term="隨筆" scheme="https://blog.downager.com/tags/%E9%9A%A8%E7%AD%86/"/>
    
      <category term="QNAP" scheme="https://blog.downager.com/tags/QNAP/"/>
    
  </entry>
  
  <entry>
    <title>[隨筆] CCNP Switch Ch.1 企業園區網路設計</title>
    <link href="https://blog.downager.com/2018/06/12/%E9%9A%A8%E7%AD%86-CCNP-Switch-Ch-1-%E4%BC%81%E6%A5%AD%E5%9C%92%E5%8D%80%E7%B6%B2%E8%B7%AF%E8%A8%AD%E8%A8%88/"/>
    <id>https://blog.downager.com/2018/06/12/%E9%9A%A8%E7%AD%86-CCNP-Switch-Ch-1-%E4%BC%81%E6%A5%AD%E5%9C%92%E5%8D%80%E7%B6%B2%E8%B7%AF%E8%A8%AD%E8%A8%88/</id>
    <published>2018-06-12T14:14:58.000Z</published>
    <updated>2020-11-19T05:50:50.459Z</updated>
    
    <content type="html"><![CDATA[<h2 id="說明-Cisco-階層式網路設計原則"><a href="#說明-Cisco-階層式網路設計原則" class="headerlink" title="說明 Cisco 階層式網路設計原則"></a>說明 Cisco 階層式網路設計原則</h2><p>可預測行為的網路模型：低維護性、高可用性</p><p>網路規劃應根據<strong>資料流</strong>來思考，理想狀況下，所有 End-User 資源存取的<strong>距離成本一致</strong>。</p><p>一個標準的網路模型：存取層、分散層、核心層</p><ol><li>存取層：終端使用者的存取接入點</li><li>分散層：匯集存取層交換器</li><li>核心層：當使用者成長到一定數量，必須匯集分散層交換器而使用</li></ol><a id="more"></a> <img src="/2018/06/12/%E9%9A%A8%E7%AD%86-CCNP-Switch-Ch-1-%E4%BC%81%E6%A5%AD%E5%9C%92%E5%8D%80%E7%B6%B2%E8%B7%AF%E8%A8%AD%E8%A8%88/CCNP_001.jpg" class=""><h2 id="說明分層網絡設計模型（Hierarchical-Network-Design-Model）"><a href="#說明分層網絡設計模型（Hierarchical-Network-Design-Model）" class="headerlink" title="說明分層網絡設計模型（Hierarchical Network Design Model）"></a>說明分層網絡設計模型（Hierarchical Network Design Model）</h2><h3 id="存取層（Access-Layer）"><a href="#存取層（Access-Layer）" class="headerlink" title="存取層（Access Layer）"></a>存取層（Access Layer）</h3><p>存取層是 End-User 的網路接入點，存取層交換器通常提供 User 之間 Layer 2（VLAN）的連結性。</p><p>此層的設備（有時被稱作 大樓存取層交換器 - Building access switch）應擁有下列功能：</p><ul><li><strong>低成本的交換埠</strong></li><li><strong>高密度的交換埠</strong></li><li>可利用上行鏈路（Uplink）擴展到上層</li><li>高可用性</li><li>能夠集中提供的網路服務（資料、語音、視訊）</li><li>防護功能與服務品質（QoS）</li></ul><h3 id="分散層（Distribution-Layer）"><a href="#分散層（Distribution-Layer）" class="headerlink" title="分散層（Distribution Layer）"></a>分散層（Distribution Layer）</h3><p>分散層匯集了所有<strong>存取層</strong>設備的 <strong>Uplink</strong>，分散層交換器必須能夠處理來自所有連線設備的<strong>總流量</strong>，</p><p>也就是應該具備<strong>高密度</strong>的<strong>高速鏈路交換埠</strong>，以便支援存取層交換器所集中的流量。</p><p>由於 VLAN 與廣播領域集中在分散層，故通常需要<strong>支援路由繞送</strong>（Support Routing）、<strong>過濾</strong>及安全性。</p><p>分散層通常為<strong>第三層</strong>的<strong>邊界</strong>，此為路由 access VLAN 之處。</p><p>此層中的設備（有時被稱作 大樓分散層交換器 - Building Distribution switch）應擁有下列功能：</p><ul><li>可<strong>匯集多個存取層交換器</strong></li><li>針對<strong>封包處理</strong>能提供更高的<strong>第 3 層路由效率</strong>（Layer 3）</li><li>提供安全性與原則型連線功能</li><li>QoS 功能</li><li>核心層與存取層之間的<strong>高速鏈路</strong>具備<strong>可擴展性</strong>與<strong>備援性</strong>（e.x. Uplink 1 GbE &gt; 10 GbE）</li></ul><h3 id="核心層（Core-Layer）"><a href="#核心層（Core-Layer）" class="headerlink" title="核心層（Core Layer）"></a>核心層（Core Layer）</h3><p>園區網路的核心層提供所有分散層設備之間的連接，故核心層（網路骨幹）交換的資料流必須盡可能地有效率。</p><p>核心層交換器應具有下列屬性：</p><ul><li>極高的 Layer 3 路由傳輸率</li><li>不執行高成本或不必要的封包處理（存取清單、封包過濾）</li><li>支援高可用性的容錯與彈性</li><li>進階的 QoS 功能</li></ul><p>在園區網路的核心層（骨幹）的設備應針對高效率交換進行最佳化，因為核心層必須處理整個園區龐大的資料量，故核心層應針對單純及效率問題來設計。</p><h2 id="模組化的網路設計"><a href="#模組化的網路設計" class="headerlink" title="模組化的網路設計"></a>模組化的網路設計</h2><h3 id="交換式區塊好處"><a href="#交換式區塊好處" class="headerlink" title="交換式區塊好處"></a>交換式區塊好處</h3><ul><li>擴充方便</li><li>不須 Full-Mesh 即有一定的可靠程度</li></ul><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-CCNP-Switch-Ch-1-%E4%BC%81%E6%A5%AD%E5%9C%92%E5%8D%80%E7%B6%B2%E8%B7%AF%E8%A8%AD%E8%A8%88/CCNP_002.jpg" class=""><h3 id="企業網路基本單元"><a href="#企業網路基本單元" class="headerlink" title="企業網路基本單元"></a>企業網路基本單元</h3><ul><li>交換式區塊（Switch Block）：</li><li>包含<strong>一群存取層交換器</strong>，以及與他們相連的<strong>分散層交換器</strong>。</li><li>亦稱作<strong>存取分散式區塊</strong>（_access distribution block_），因包含這兩個交換層而得此名。</li><li>核心區塊（Core Block）：園區網路的<strong>骨幹</strong>，連接所有的<strong>交換式區塊</strong></li></ul><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-CCNP-Switch-Ch-1-%E4%BC%81%E6%A5%AD%E5%9C%92%E5%8D%80%E7%B6%B2%E8%B7%AF%E8%A8%AD%E8%A8%88/CCNP_003.jpg" class=""><h3 id="交換式區塊大小"><a href="#交換式區塊大小" class="headerlink" title="交換式區塊大小"></a>交換式區塊大小</h3><h4 id="分散層大小如何決定："><a href="#分散層大小如何決定：" class="headerlink" title="分散層大小如何決定："></a>分散層大小如何決定：</h4><ul><li>資料流類型及模式</li><li><strong>共同工作</strong>的<strong>群組</strong>與數量</li><li>分散層上 Layer 3 交換容量之數量</li><li>連接到存取層的 User 總數</li><li><strong>Subnet</strong> 或 <strong>VLAN</strong> 之地理邊界</li><li>一個<strong>交換式區塊</strong>內的使用者總數不超過 <strong>2000</strong> 個</li></ul><h4 id="交換式區塊過大時的狀況："><a href="#交換式區塊過大時的狀況：" class="headerlink" title="交換式區塊過大時的狀況："></a>交換式區塊過大時的狀況：</h4><ul><li>分散層的 Router（Layer 3 Switch）成為流量瓶頸。</li><li>原因可能有：<ul><li>跨 VLAN 的流量過高</li><li>CPU 處理過於密集</li><li>封包原則或安全性功能過多導致交換時間過長</li><li>Broadcast 和 Multicast 流量過多，導致佔用了交換式區塊的交換處理速度。</li></ul></li></ul><h3 id="交換式區塊備援設計"><a href="#交換式區塊備援設計" class="headerlink" title="交換式區塊備援設計"></a>交換式區塊備援設計</h3><h4 id="設計原則："><a href="#設計原則：" class="headerlink" title="設計原則："></a>設計原則：</h4><ul><li>每個<strong>交換式區塊</strong>由 2 台<strong>分散層交換器</strong>所組成</li><li>每台<strong>存取層交換器</strong>應具備<strong>一對 uplink</strong></li><li>每一個<strong>存取層交換器</strong>只能負責<strong>唯一</strong>一個** VLAN **，避免形成 Layer 2 的邏輯迴圈。</li></ul><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-CCNP-Switch-Ch-1-%E4%BC%81%E6%A5%AD%E5%9C%92%E5%8D%80%E7%B6%B2%E8%B7%AF%E8%A8%AD%E8%A8%88/CCNP_004.jpg" class=""><h3 id="階層網路備援設計原則"><a href="#階層網路備援設計原則" class="headerlink" title="階層網路備援設計原則"></a>階層網路備援設計原則</h3><ul><li>每個階層使用<strong>一對</strong>的交換器</li><li>每台交換器利用<strong>兩條 Uplink</strong> 作為備援之用</li><li><strong>分散層</strong>之間連接<strong>一條鏈路</strong>作為備援即可</li><li><strong>存取層</strong>交換器原則上<strong>不要直連</strong></li><li>VLAN（<strong>Layer 2</strong>）的範圍<strong>不要</strong>超出<strong>分散層</strong>交換器</li></ul><h2 id="網路核心"><a href="#網路核心" class="headerlink" title="網路核心"></a>網路核心</h2><h3 id="核心層"><a href="#核心層" class="headerlink" title="核心層"></a>核心層</h3><ul><li><strong>分散</strong>與<strong>核心</strong>交換器之間的鏈路最好是<strong>第 3 層路由介面</strong></li><li>核心層交換器<strong>之間</strong>的鏈路，最好能夠乘載匯集進入其中一台核心交換器的流量</li><li>考慮未來擴充的方便性 e.x. 1GbE Module to 10GbE Module</li><li>核心層應當含括<strong>兩台</strong>多層交換器，備援核心被稱為<strong>雙核心</strong>（Dual Core）</li><li>核心層形成一個獨立的模組，未併入其他區塊或階層</li></ul><h3 id="多節點核心（Multinode-Core）"><a href="#多節點核心（Multinode-Core）" class="headerlink" title="多節點核心（Multinode Core）"></a>多節點核心（Multinode Core）</h3><p>當園區網路成長到橫跨兩棟大樓或兩個地區時，核心層即可倍增</p><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-CCNP-Switch-Ch-1-%E4%BC%81%E6%A5%AD%E5%9C%92%E5%8D%80%E7%B6%B2%E8%B7%AF%E8%A8%AD%E8%A8%88/CCNP_005.jpg" class=""><p>核心層彼此以 <strong>Full-Mesh</strong> 狀態建構，達到互相備援的狀態。</p><h3 id="整合式核心區塊（Collapsed-core-block）"><a href="#整合式核心區塊（Collapsed-core-block）" class="headerlink" title="整合式核心區塊（Collapsed core block）"></a>整合式核心區塊（Collapsed core block）</h3><ul><li>分散層以及核心層雖然實作在相同設備上，但保持這些功能的獨立性及適當設計很重要</li><li>整合式核心非獨立的單元區塊，而是整合到個別獨立交換式區塊的分散層裡</li></ul><img src="/2018/06/12/%E9%9A%A8%E7%AD%86-CCNP-Switch-Ch-1-%E4%BC%81%E6%A5%AD%E5%9C%92%E5%8D%80%E7%B6%B2%E8%B7%AF%E8%A8%AD%E8%A8%88/CCNP_006.jpg" class=""><h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><p>本篇文章為本人閱讀碁峰出版《CCNP Routing and Switching SWITCH 300-115專業認證手冊》第一章後所整理出的筆記，圖片皆是出自於該書內容，若有侵權疑慮請來信或留言告知，將盡速撤下文章。</p><p>請各位支持正版：<a href="http://www.books.com.tw/products/E050025504" target="_blank" rel="noopener">博客來</a>、<a href="https://play.google.com/store/books/details?id=cUsfDQAAQBAJ" target="_blank" rel="noopener">Google圖書</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;說明-Cisco-階層式網路設計原則&quot;&gt;&lt;a href=&quot;#說明-Cisco-階層式網路設計原則&quot; class=&quot;headerlink&quot; title=&quot;說明 Cisco 階層式網路設計原則&quot;&gt;&lt;/a&gt;說明 Cisco 階層式網路設計原則&lt;/h2&gt;&lt;p&gt;可預測行為的網路模型：低維護性、高可用性&lt;/p&gt;
&lt;p&gt;網路規劃應根據&lt;strong&gt;資料流&lt;/strong&gt;來思考，理想狀況下，所有 End-User 資源存取的&lt;strong&gt;距離成本一致&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;一個標準的網路模型：存取層、分散層、核心層&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;存取層：終端使用者的存取接入點&lt;/li&gt;
&lt;li&gt;分散層：匯集存取層交換器&lt;/li&gt;
&lt;li&gt;核心層：當使用者成長到一定數量，必須匯集分散層交換器而使用&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="Networking" scheme="https://blog.downager.com/categories/Networking/"/>
    
    
      <category term="網路" scheme="https://blog.downager.com/tags/%E7%B6%B2%E8%B7%AF/"/>
    
      <category term="隨筆" scheme="https://blog.downager.com/tags/%E9%9A%A8%E7%AD%86/"/>
    
      <category term="CCNP" scheme="https://blog.downager.com/tags/CCNP/"/>
    
  </entry>
  
</feed>
